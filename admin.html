<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>B≈ëv√≠tett Admin Panel ‚Äì SzakiChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#f4f4f4; font-family:Arial; }
header {
    background:#111; color:white; padding:18px;
    font-size:22px; font-weight:bold; text-align:center;
}

.container {
    max-width:900px; margin:20px auto; padding:10px;
}

.searchBox input {
    width:100%; padding:12px; border-radius:8px;
    border:1px solid #ccc; font-size:16px;
}

.userCard {
    background:white; padding:14px; margin-top:12px;
    border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

.userCard .row { margin-top:6px; }
.userCard button {
    padding:8px 12px; margin:4px; border:none;
    border-radius:8px; cursor:pointer; font-weight:bold;
}
.btn-danger { background:#d60000; color:white; }
.btn-action { background:#007aff; color:white; }
.btn-premium { background:#ff9f00; color:white; }
.btn-small { font-size:13px; }

.tagOnline { color:green; font-weight:bold; }
.tagOffline { color:red; font-weight:bold; }
.tagPremium { color:#ff9f00; font-weight:bold; }

hr { margin:25px 0; }

.linkBar {
    padding:14px; background:#fff; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.linkBar a {
    display:inline-block; padding:10px 14px;
    background:#007aff; color:white; border-radius:8px;
    margin-right:10px; margin-bottom:10px;
    text-decoration:none;
}

/* ‚ù§Ô∏è ADOM√ÅNY GOMB */
#supportBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background:#ff2d55;
    color:white;
    padding:14px 22px;
    border-radius:40px;
    font-weight:bold;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    z-index:999;
}
</style>
</head>

<body>

<header>B≈êV√çTETT ADMIN PANEL</header>

<div id="supportBtn"
onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
‚ù§Ô∏è T√°mogasd a SzakiChat-et
</div>

<div class="container">

    <!-- Gyorslinkek -->
    <div class="linkBar">
        <a href="admin-chats.html">üí¨ √ñsszes chat</a>
        <a href="admin-stats.html">üìä Statisztik√°k</a>
        <a href="admin-login.html">üö™ Kil√©p√©s</a>
    </div>

    <h2>Felhaszn√°l√≥k</h2>
    <div class="searchBox">
        <input type="text" id="searchInput" placeholder="Keres√©s n√©v, email vagy v√°ros alapj√°n...">
    </div>

    <div id="userList"></div>
</div>

<script type="module">

/* FIREBASE IMPORT */
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    collection, onSnapshot,
    doc, updateDoc, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const ADMIN_EMAIL = "admin@szakichat.hu";

const userList = document.getElementById("userList");
const searchInput = document.getElementById("searchInput");
let users = [];

/* ===========================================================================================
   üîí ADMIN ELLEN≈êRZ√âS ‚Äì EMAIL ALAP√ö, EZ A HELYES!
=========================================================================================== */
onAuthStateChanged(auth, async (user) => {

    if (!user) {
        window.location.href = "admin-login.html";
        return;
    }

    if (user.email !== ADMIN_EMAIL) {
        alert("Nincs admin jogosults√°g!");
        window.location.href = "admin-login.html";
        return;
    }

    // Itt m√°r admin ‚Üí t√∂lthetj√ºk az adatokat
    loadUserList();
});

/* ===========================================================================================
   REALTIME FELHASZN√ÅL√ì LISTA
=========================================================================================== */
function loadUserList() {
    onSnapshot(collection(db, "users"), (snap) => {
        users = [];
        snap.forEach(d => users.push({ id: d.id, ...d.data() }));
        render();
    });
}

/* ===========================================================================================
   KERES√âS
=========================================================================================== */
searchInput.onkeyup = render;

function render() {
    const q = searchInput.value.toLowerCase();
    userList.innerHTML = "";

    users
        .filter(u =>
            (u.name || "").toLowerCase().includes(q) ||
            (u.email || "").toLowerCase().includes(q) ||
            (u.city || "").toLowerCase().includes(q)
        )
        .forEach(u => displayUser(u));
}

/* ===========================================================================================
   FELHASZN√ÅL√ì K√ÅRTYA
=========================================================================================== */
function displayUser(u) {

    const onlineTag = u.online
        ? `<span class="tagOnline">üü¢ Online</span>`
        : `<span class="tagOffline">‚ö™ Offline</span>`;

    const premiumTag = u.premium
        ? `<span class="tagPremium">‚òÖ Pr√©mium</span>`
        : "";

    const roleLabel = u.role || "felhaszn√°l√≥";

    userList.innerHTML += `
        <div class="userCard">
            <div class="row"><b>${u.name || "-"}</b> (${roleLabel}) ${premiumTag}</div>
            <div class="row">Email: ${u.email || "-"}</div>
            <div class="row">V√°ros: ${u.city || "-"}</div>
            <div class="row">Szakma: ${u.szakma || "-"}</div>
            <div class="row">${onlineTag}</div>

            <div class="row">
                <button class="btn-action btn-small"
                    onclick="togglePremium('${u.id}', ${!!u.premium})">
                    ${u.premium ? "Pr√©mium kikapcs" : "Pr√©mium bekapcs"}
                </button>

                <button class="btn-action btn-small"
                    onclick="resetChats('${u.id}')">Chat sz√°ml√°l√≥ null√°z√°sa</button>

                <button class="btn-danger btn-small"
                    onclick="banUser('${u.id}')">Blokkol√°s</button>
            </div>
        </div>
    `;
}

/* ===========================================================================================
   PR√âMIUM KEZEL√âS
=========================================================================================== */
window.togglePremium = async function(uid, current) {
    await updateDoc(doc(db, "users", uid), { premium: !current });
    logAction(uid, current ? "Pr√©mium kikapcsolva" : "Pr√©mium bekapcsolva");
};

/* ===========================================================================================
   CHAT COUNT NULL√ÅZ√ÅS
=========================================================================================== */
window.resetChats = async function(uid) {
    await updateDoc(doc(db, "users", uid), { chatCount: 0 });
    alert("Chat sz√°ml√°l√≥ null√°zva!");
    logAction(uid, "Chat sz√°ml√°l√≥ null√°zva");
};

/* ===========================================================================================
   BLOKKOL√ÅS
=========================================================================================== */
window.banUser = async function(uid) {
    await updateDoc(doc(db, "users", uid), { banned: true });
    alert("Felhaszn√°l√≥ blokkolva!");
    logAction(uid, "Felhaszn√°l√≥ blokkolva");
};

/* ===========================================================================================
   ADMIN LOG
=========================================================================================== */
async function logAction(targetUid, actionText) {
    await setDoc(doc(db, "adminLogs", Date.now().toString()), {
        target: targetUid,
        action: actionText,
        time: new Date().toISOString()
    });
}

</script>

</body>
</html>

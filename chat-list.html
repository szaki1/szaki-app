// ==========================================================
//  SzakiChat â€“ chat-list.js
//  Chatlista valÃ³s idejÅ± megjelenÃ­tÃ©se Firestore-bÃ³l
// ==========================================================

import { db } from "./firebase-config.js";
import {
    doc,
    getDoc,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getPartnerData } from "./messages.js";


// ==========================================================
// CHAT LISTA BETÃ–LTÃ‰SE
// ==========================================================
export function startChatList() {
    const uid = localStorage.getItem("uid");
    if (!uid) {
        alert("Nincs bejelentkezett felhasznÃ¡lÃ³!");
        window.location.href = "login.html";
        return;
    }

    const userRef = doc(db, "users", uid);

    // ValÃ³s idejÅ± figyelÃ©s
    onSnapshot(userRef, async (snap) => {
        if (!snap.exists()) return;

        const data = snap.data();
        const chatList = data.chatList || {};

        const container = document.getElementById("chatListContainer");
        container.innerHTML = "";

        const entries = Object.entries(chatList);

        if (entries.length === 0) {
            container.innerHTML = `<p style="color:#777; text-align:center;">
                Nincsenek beszÃ©lgetÃ©seid.
            </p>`;
            return;
        }

        // chat elemek megjelenÃ­tÃ©se
        for (const [chatId, info] of entries) {

            const partnerUid = info.uid;
            const partner = await getPartnerData(partnerUid);

            const row = document.createElement("div");
            row.className = "chat-row";

            const unread = info.unread > 0
                ? `<span class="unread">${info.unread}</span>`
                : "";

            row.innerHTML = `
                <div class="chat-left">
                    <div class="chat-name">${partner.name}</div>
                    <div class="chat-last">${info.lastMessage || "Nincs Ã¼zenet"}</div>
                </div>

                <div class="chat-right">
                    <div class="chat-status">
                        ${partner.online ? "ðŸŸ¢" : "âšª"}
                    </div>
                    ${unread}
                </div>
            `;

            row.onclick = () => {
                window.location.href =
                    `chat.html?chatId=${chatId}&partner=${encodeURIComponent(partner.name)}`;
            };

            container.appendChild(row);
        }
    });
}

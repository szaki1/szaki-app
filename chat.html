<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <title>Chat ‚Äì Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00;
      padding:12px 16px;
      color:#fff;
      font-weight:bold;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .top-bar {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:10px 14px;
      font-size:13px;
      border-bottom:1px solid #eee;
    }

    .top-row { display:flex; gap:16px; flex-wrap:wrap; }
    .top-row b { font-weight:bold; }

    #onlineStatus {
        font-size:12px;
        margin-top:4px;
        font-weight:bold;
    }
    .online { color:#00aa00; }
    .offline { color:#cc0000; }

    #chat-box {
      max-width:900px;
      margin:12px auto;
      padding:12px 14px;
      background:white;
      border-radius:10px;
      height:55vh;
      overflow-y:auto;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      font-size:14px;
    }

    .msg { margin:6px 0; }
    .own { font-weight:bold; }
    .meta { color:#777; font-size:11px; margin-left:6px; }
    .del { margin-left:10px; color:#c00; cursor:pointer; font-size:11px; }

    .notify {
      color:#28a745;
      font-size:11px;
      margin-left:10px;
      display:none;
    }

    .input-row {
      max-width:900px;
      margin:0 auto 14px;
      display:flex;
      gap:8px;
      padding:0 14px;
    }

    #message-input {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }
    .send-btn {
      padding:10px 18px;
      border:none;
      border-radius:8px;
      background:#ff8c00;
      color:white;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
    }
</style>
</head>
<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>
<div id="chat-box"><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></div>

<div class="input-row">
    <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
    <button id="send-btn" class="send-btn">K√ºld√©s</button>
</div>

<script type="module">

import { app, db } from "./firebase-config.js";
import {
    collection, doc, addDoc, query, orderBy, onSnapshot,
    serverTimestamp, updateDoc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ---------------------------------------------------------
    PARAM√âTEREK BEOLVAS√ÅSA
---------------------------------------------------------*/
const params = new URLSearchParams(window.location.search);

let USER = params.get("sender") || localStorage.getItem("user") || "Megrendel≈ë";
let PARTNER = params.get("partner") || "Szakember";
localStorage.setItem("user", USER);

// Ha megrendel≈ë v√°lasztott m√°sik szakit ‚Üí jelezz√ºk a szakiknak
let valasztott = params.get("selected") || "";


/* ---------------------------------------------------------
    TELEFONSZ√ÅM + EMAIL MASZK V√âDELEM
---------------------------------------------------------*/
function violatesPolicy(text) {
    const phoneRegex = /\b(\+?\d[\d\s-]{7,})\b/;
    const emailRegex = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;

    return phoneRegex.test(text) || emailRegex.test(text);
}

function warningMessage() {
    return (
"Kedves felhaszn√°l√≥!\n\n" +
"Az√©rt haszn√°lhatod INGYEN a Szaki-Appot, mert a szakikkal itt a CHATEN besz√©ltek meg mindent!\n\n" +
"üìå 5 MEGOSZT√ÅS√âRT cser√©be l√°that√≥v√° v√°lik a telefonsz√°m / email!\n\n" +
"K√∂sz√∂nj√ºk, hogy megosztod az oldalt m√°sokkal!"
    );
}


/* ---------------------------------------------------------
    TOP BAR KI√çR√ÅSA
---------------------------------------------------------*/
document.getElementById("top-bar").innerHTML = `
  <div class="top-row">
    <div><b>Te:</b> ${USER}</div>
    <div><b>Partner:</b> ${PARTNER}</div>
  </div>
  <div id="onlineStatus">Ellen≈ërz√©s‚Ä¶</div>
`;


/* ---------------------------------------------------------
    ONLINE st√°tusz jelz√©s FIRESTORE-b√≥l
---------------------------------------------------------*/
const partnerRef = doc(db, "users", PARTNER);

async function updateOwnOnlineStatus() {
    await setDoc(doc(db, "users", USER), {
        online: true,
        lastSeen: Date.now()
    }, { merge: true });
}

setInterval(updateOwnOnlineStatus, 15000);
updateOwnOnlineStatus();

onSnapshot(partnerRef, (snap) => {
    const d = snap.data();
    const el = document.getElementById("onlineStatus");

    if (!d) {
        el.textContent = "Partner offline";
        el.className = "offline";
        return;
    }

    el.textContent = d.online ? "Partner ONLINE" : "Partner OFFLINE";
    el.className = d.online ? "online" : "offline";
});

/* ---------------------------------------------------------
    FIRESTORE CHAT SZOB√ÅK
---------------------------------------------------------*/
function roomId(a,b){
    return [a.toLowerCase(), b.toLowerCase()].sort().join("__");
}

const ROOM = roomId(USER, PARTNER);

const chatRef = doc(db, "chats", ROOM);
const msgRef  = collection(db, "chats", ROOM, "messages");

// Ha nem ≈ët v√°lasztott√°k ‚Üí automatikus √©rtes√≠t√©s szakiknak
if (valasztott === "no" && USER !== PARTNER) {
    await addDoc(msgRef, {
        senderName: "Rendszer",
        text: "Sajn√°ljuk, a megrendel≈ë m√°sik szakembert v√°lasztott.",
        timestamp: serverTimestamp()
    });
}


/* ---------------------------------------------------------
    √úZENET LISTENER
---------------------------------------------------------*/
const chatBox = document.getElementById("chat-box");

onSnapshot(
    query(msgRef, orderBy("timestamp")),
    (snap) => {
        chatBox.innerHTML = "";
        snap.forEach(docSnap => {
            const msg = docSnap.data();
            const p = document.createElement("p");
            const own = msg.senderName === USER ? "own" : "";
            const time = formatTs(msg.timestamp);

            p.innerHTML =
                `<span class="${own}">${msg.senderName}:</span> ` +
                `${escape(msg.text)} <span class="meta">(${time})</span>`;

            chatBox.appendChild(p);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    }
);


/* ---------------------------------------------------------
    √úZENET K√úLD√âS
---------------------------------------------------------*/
document.getElementById("send-btn").onclick = sendMsg;
document.getElementById("message-input").onkeydown = (e)=>{
    if (e.key === "Enter") sendMsg();
};

async function sendMsg() {
    const text = document.getElementById("message-input").value.trim();
    if (!text) return;

    let finalText = text;

    if (violatesPolicy(text)) {
        finalText = warningMessage();
    }

    await addDoc(msgRef, {
        senderName: USER,
        text: finalText,
        timestamp: serverTimestamp()
    });

    document.getElementById("message-input").value = "";
}


/* ---------------------------------------------------------
    SEG√âDF√úGGV√âNYEK
---------------------------------------------------------*/
function escape(str){
    const div=document.createElement("div");
    div.innerText=str;
    return div.innerHTML;
}

function formatTs(ts){
    try {
        const d = ts.toDate();
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch {
        return "";
    }
}

function pad(n){ return n < 10 ? "0"+n : n; }

</script>

</body>
</html>

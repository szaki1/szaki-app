<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="utf-8" />
    <title>Chat – Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
        header { background:#ff8c00; color:#fff; padding:14px; text-align:center; font-weight:bold; }
        .container { max-width:900px; margin:16px auto; padding:12px; }
        .meta { background:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
        .meta div { margin:4px 0; }
        .chat-window { background:#fff; height:400px; overflow:auto; border-radius:8px; margin-top:12px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
        .msg { margin:8px 0; max-width:75%; padding:8px 10px; border-radius:10px; }
        .msg.me { background:#dcf8c6; margin-left:auto; text-align:right; }
        .msg.other { background:#f1f0f0; margin-right:auto; text-align:left; }
        .composer { display:flex; gap:8px; margin-top:10px; }
        input[type="text"] { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
        button { padding:10px 14px; border-radius:8px; border:none; background:#28a745; color:#fff; font-weight:bold; cursor:pointer; }
        a.back { display:inline-block; margin-top:8px; color:#007bff; text-decoration:none; }
        .note { font-size:13px; color:#666; margin-top:8px; }
    </style>
</head>
<body>
<header>Chat – Szaki-App</header>
<div class="container">
    <div class="meta" id="meta">
        <div><strong>Megrendelő:</strong> <span id="senderText">-</span></div>
        <div><strong>Szakember:</strong> <span id="partnerText">-</span></div>
        <a id="backLink" class="back" href="#">◀ Vissza a kereséshez</a>
    </div>

    <div id="chatWindow" class="chat-window" aria-live="polite" aria-label="Beszélgetés">
        <!-- üzenetek ide lesznek renderelve -->
    </div>

    <div class="composer">
        <input id="msgInput" type="text" placeholder="Írj üzenetet..." aria-label="Üzenet beviteli mező" />
        <button id="sendBtn" type="button">Küldés</button>
    </div>

    <div class="note">
        Ez egy egyszerű, helyi demo-chat. Üzenetek a böngészőben (localStorage) tárolódnak.
    </div>
</div>

<script>
(function(){
    function getParam(name) {
        return new URLSearchParams(window.location.search).get(name) || "";
    }

    const sender = decodeURIComponent(getParam('sender') || '').trim() || 'Megrendelő';
    const partner = decodeURIComponent(getParam('partner') || '').trim() || 'Szakember';

    // meta megjelenítés (biztonságos textContent használatával)
    document.getElementById('senderText').textContent = sender;
    document.getElementById('partnerText').textContent = partner;

    // back link vissza a választó oldalra, megtartva a szakma és megrendelonev paramétert ha volt
    (function setupBackLink(){
        // ha volt eredeti szakma paraméter, próbáljuk arra visszavezetni (ha nincs, csak valassz-szakit.html)
        const params = new URLSearchParams(window.location.search);
        let backUrl = 'valassz-szakit.html';
        // ha a url tartalmaz szakma vagy megrendelonev, akkor azokat továbbadjuk
        const szakma = params.get('szakma');
        const megr = params.get('megrendelonev');
        const bp = new URLSearchParams();
        if (szakma) bp.set('szakma', szakma);
        if (megr) bp.set('megrendelonev', megr);
        const q = bp.toString();
        if (q) backUrl += '?' + q;
        const link = document.getElementById('backLink');
        link.href = backUrl;
    })();

    // localStorage kulcs beszélgetéshez
    function chatKey(a,b){
        // normalizálunk: kisbetű, eltávolítunk szóközöket a kulcsban
        return 'chat_' + encodeURIComponent(String(a).trim().toLowerCase()) + '_' + encodeURIComponent(String(b).trim().toLowerCase());
    }

    function loadMessages(){
        try {
            const raw = localStorage.getItem(chatKey(sender, partner));
            if (!raw) return [];
            return JSON.parse(raw);
        } catch (e) {
            return [];
        }
    }

    function saveMessages(arr){
        try {
            localStorage.setItem(chatKey(sender, partner), JSON.stringify(arr));
        } catch (e) {
            // ha nem fér el, semmi — csak nem tárolunk
        }
    }

    function renderMessages(){
        const wnd = document.getElementById('chatWindow');
        wnd.innerHTML = ''; // biztonságos: csak textContent-ot fogunk létrehozni
        const msgs = loadMessages();
        msgs.forEach(m => {
            const d = document.createElement('div');
            d.className = 'msg ' + (m.from === sender ? 'me' : 'other');
            // szerkesztésmentes megjelenítés
            const who = document.createElement('div');
            who.style.fontSize = '12px';
            who.style.color = '#555';
            who.textContent = m.from;
            const text = document.createElement('div');
            text.style.marginTop = '4px';
            text.textContent = m.text;
            const ts = document.createElement('div');
            ts.style.fontSize = '11px';
            ts.style.color = '#888';
            ts.style.marginTop = '6px';
            ts.textContent = (new Date(m.when)).toLocaleString();
            d.appendChild(who);
            d.appendChild(text);
            d.appendChild(ts);
            wnd.appendChild(d);
        });
        // legörgetés a végére
        wnd.scrollTop = wnd.scrollHeight;
    }

    function sendMessage(text){
        if (!text || !text.trim()) return;
        const msgs = loadMessages();
        msgs.push({ from: sender, text: text.trim(), when: (new Date()).toISOString() });
        saveMessages(msgs);
        renderMessages();
    }

    document.getElementById('sendBtn').addEventListener('click', function(){
        const inp = document.getElementById('msgInput');
        sendMessage(inp.value);
        inp.value = '';
        inp.focus();
    });

    // Enter küldés
    document.getElementById('msgInput').addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('sendBtn').click();
        }
    });

    // első render
    renderMessages();

    // ha nincs sender/partner param, figyelmeztetés
    if (!getParam('sender') || !getParam('partner')) {
        // mutatjuk, de nem akadályozzuk meg a használatot
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = 'Figyelem: a chat működéséhez a sender és partner paraméter megadása ajánlott az URL-ben.';
        document.querySelector('.container').insertBefore(note, document.querySelector('.container').lastElementChild);
    }
})();
</script>
</body>
</html>

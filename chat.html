<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Chat ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">

    <style>
        body {
            margin:0;
            height:100vh;
            display:flex;
            flex-direction:column;
            background:#f2f2f2;
        }

        #chatHeader {
            background:#007aff;
            color:white;
            padding:14px;
            font-size:18px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        #messages {
            flex:1;
            overflow-y:auto;
            padding:16px;
        }

        .msg {
            max-width:75%;
            padding:10px 14px;
            border-radius:12px;
            margin-bottom:12px;
            word-wrap:break-word;
            font-size:15px;
            box-shadow:0 2px 6px rgba(0,0,0,0.08);
        }

        .me { background:#007aff; color:white; margin-left:auto; }
        .other { background:white; color:black; margin-right:auto; }

        #inputBar {
            display:flex;
            padding:10px;
            background:white;
            border-top:1px solid #ddd;
        }

        #msgInput {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:8px;
            margin-right:10px;
        }

        #sendBtn {
            background:#007aff;
            color:white;
            padding:10px 16px;
            border:none;
            border-radius:8px;
            cursor:pointer;
        }

        #lockWarning {
            display:none;
            background:#ffd4d4;
            color:#8b0000;
            padding:10px;
            text-align:center;
            font-weight:bold;
        }
    </style>
</head>

<body>

<div id="chatHeader">
    <div id="partnerName">Chat</div>
    <div id="partnerStatus">‚ö™</div>
</div>

<div id="lockWarning">üîí Telefonsz√°m k√ºld√©se z√°rolva! (Legal√°bb 5 megoszt√°s kell)</div>

<div id="messages">Bet√∂lt√©s...</div>

<div id="inputBar">
    <input id="msgInput" type="text" placeholder="√çrj √ºzenetet...">
    <button id="sendBtn">K√ºld√©s</button>
</div>


<!-- ‚ù§Ô∏è Lebeg≈ë t√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">

/* ============================================================
   IMPORTOK
============================================================ */
import { db } from "./firebase-config.js";

import {
    doc,
    getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
    sendMessage,
    subscribeToMessages,
    getPartnerData
} from "./messages.js";


/* ============================================================
   URL PARAM√âTEREK
============================================================ */
const params = new URLSearchParams(window.location.search);
const chatId = params.get("chatId");
const partner = params.get("partner");

if (!chatId) {
    alert("Chat hiba: nincs chatId!");
    window.location.href = "chat-list.html";
}

document.getElementById("partnerName").innerText = partner;


/* ============================================================
   ALAP ADATOK BET√ñLT√âSE
============================================================ */
const myUid = localStorage.getItem("uid");
if (!myUid) window.location.href = "login.html";

let myData = null;
let partnerData = null;

// partner adatok beolvas√°sa
const partnerSnap = await getPartnerDataFromFirestore(partner);
if (partnerSnap) {
    partnerData = partnerSnap;
    document.getElementById("partnerStatus").innerText =
        partnerData.online ? "üü¢" : "‚ö™";
}

// saj√°t user adatok
const meRef = doc(db, "users", myUid);
const meSnap = await getDoc(meRef);
myData = meSnap.data();


async function getPartnerDataFromFirestore(nameOrUid) {
    // partner uid URL-ben van ‚Üí gyorsabb
    const pRef = doc(db, "users", nameOrUid);
    const pSnap = await getDoc(pRef);
    return pSnap.data();
}


/* ============================================================
   √úZENETEK BET√ñLT√âSE (VAL√ìS ID≈êBEN)
============================================================ */
const msgBox = document.getElementById("messages");

subscribeToMessages(chatId, (messages) => {
    msgBox.innerHTML = "";

    messages.forEach((m) => {
        const div = document.createElement("div");
        div.className = "msg " + (m.sender === myUid ? "me" : "other");
        div.innerText = m.text;
        msgBox.appendChild(div);
    });

    msgBox.scrollTop = msgBox.scrollHeight;
});


/* ============================================================
   √úZENET K√úLD√âSE
============================================================ */
document.getElementById("sendBtn").onclick = send;
document.getElementById("msgInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") send();
});

async function send() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;

    // Telefonsz√°m v√©delem
    if (myData.shareCount < 5 && /[0-9]{7,}/.test(text)) {
        document.getElementById("lockWarning").style.display = "block";
        return;
    }

    await sendMessage(chatId, myUid, text);

    input.value = "";
}

</script>
</body>
</html>

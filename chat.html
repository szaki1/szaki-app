<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00; padding:12px 16px; color:#fff;
      font-weight:bold; font-size:18px; text-align:center;
    }

    .top-bar{
      max-width:900px; margin:0 auto; background:white;
      padding:10px 14px; border-bottom:1px solid #eee; font-size:13px;
    }
    .top-row{ display:flex; flex-wrap:wrap; gap:16px; }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .status-line{
      font-size:12px;
      color:#666;
      margin-top:4px;
    }

    .warning-msg{
      margin:6px 0; padding:10px; background:#fff7e1;
      border-left:4px solid #ff8c00; border-radius:6px;
      font-size:13px; color:#8a5a00;
    }

    .input-row{
      max-width:900px; margin:0 auto 14px; padding:0 14px;
      display:flex; gap:8px;
    }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>

<script type="module">

  //-----------------------------------------------------
  // IMPORTOK
  //-----------------------------------------------------
  import { app, db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // users-status.js integr√°l√°sa
  import {
      initUserStatus,
      watchUserStatus,
      formatLastActive
  } from "./users-status.js";

  //-----------------------------------------------------
  // PARAM√âTEREK
  //-----------------------------------------------------
  const params = new URLSearchParams(window.location.search);

  let USER_NAME = params.get("sender") || localStorage.getItem("szakiName");
  if (!USER_NAME) USER_NAME = prompt("Neved:") || "Ismeretlen";
  localStorage.setItem("szakiName", USER_NAME);

  const PARTNER_NAME = params.get("partner") || "Ismeretlen";

  const ROOM_ID = createRoomId(USER_NAME, PARTNER_NAME);

  //-----------------------------------------------------
  // ONLINE ST√ÅTUSZ AKTIV√ÅL√ÅSA
  //-----------------------------------------------------
  initUserStatus({
      userName: USER_NAME,
      role: "user"
  });

  //-----------------------------------------------------
  // FEJL√âC KIT√ñLT√âSE
  //-----------------------------------------------------
  document.getElementById("top-bar").innerHTML = `
    <div class="top-row">
      <div><b>Te:</b> ${USER_NAME}</div>
      <div><b>Partner:</b> ${PARTNER_NAME}</div>
      <div><b>Szoba:</b> ${ROOM_ID}</div>
    </div>
    <div id="partner-status" class="status-line"></div>
  `;

  //-----------------------------------------------------
  // PARTNER ONLINE ST√ÅTUSZ REALTIME FIGYEL√âSE
  //-----------------------------------------------------
  watchUserStatus(PARTNER_NAME, (data) => {
      const el = document.getElementById("partner-status");
      if (!data) {
         el.textContent = "Nincs st√°tusz adat.";
         return;
      }

      if (data.isOnline) {
         el.textContent = "üü¢ Partner online";
      } else {
         el.textContent = "‚ö™ Utolj√°ra akt√≠v: " + formatLastActive(data.lastActive);
      }
  });

  //-----------------------------------------------------
  // FIRESTORE HIVATKOZ√ÅSOK
  //-----------------------------------------------------
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  try {
      await updateDoc(chatRef, {
          roomId: ROOM_ID,
          status: "active",
          lastMessageAt: serverTimestamp()
      });
  } catch {}

  //-----------------------------------------------------
  // √úZENET FIGYEL√âS
  //-----------------------------------------------------
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const own = msg.senderName === USER_NAME ? "own" : "";
          const t = formatTimestamp(msg.timestamp);

          const p = document.createElement("p");
          p.className = "msg";

          p.innerHTML =
            `<span class="${own}">${msg.senderName}:</span> ${escapeHtml(msg.text)} <span class="meta">(${t})</span>`;

          chatBox.appendChild(p);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  //-----------------------------------------------------
  // K√úLD√âS GOMB
  //-----------------------------------------------------
  document.getElementById("send-btn").onclick = () => sendMsg();
  document.getElementById("message-input").onkeydown = (e) => {
      if (e.key === "Enter") sendMsg();
  };

  async function sendMsg() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;

      await addDoc(messagesRef, {
          senderName: USER_NAME,
          text,
          timestamp: serverTimestamp()
      });

      await updateDoc(chatRef, {
          lastMessageAt: serverTimestamp()
      });

      input.value = "";
  }

  //-----------------------------------------------------
  // SEG√âDEK
  //-----------------------------------------------------
  function escapeHtml(s){
      const d = document.createElement("div");
      d.innerText = s;
      return d.innerHTML;
  }

  function createRoomId(a,b){
      const x = (a||"").toLowerCase().trim();
      const y = (b||"").toLowerCase().trim();
      return [x,y].sort().join("__");
  }

  function formatTimestamp(ts){
      try{
          const d = ts.toDate();
          return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch{ return ""; }
  }

  function pad(n){ return n<10 ? "0"+n : n; }

</script>

</body>
</html>

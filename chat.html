<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00; padding:12px 16px; color:#fff;
      font-weight:bold; font-size:18px; text-align:center;
    }

    .top-bar{
      max-width:900px; margin:0 auto; background:white;
      padding:10px 14px; border-bottom:1px solid #eee; font-size:13px;
    }
    .top-row{ display:flex; flex-wrap:wrap; gap:16px; }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .warning-msg{
      margin:6px 0; padding:10px; background:#fff7e1;
      border-left:4px solid #ff8c00; border-radius:6px;
      font-size:13px; color:#8a5a00;
    }

    .input-row{
      max-width:900px; margin:0 auto 14px; padding:0 14px;
      display:flex; gap:8px;
    }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }

    /* --- D√ñNT≈ê GOMBOK --- */
    #decision-buttons{
      max-width:900px;
      margin:10px auto;
      padding:0 14px;
      display:flex;
      gap:10px;
    }

    #decision-buttons button{
      flex:1;
      padding:12px;
      border:none;
      border-radius:10px;
      font-weight:bold;
      cursor:pointer;
      font-size:15px;
    }

    #btn-choose{ background:#28a745; color:white; }
    #btn-reject{ background:#c00; color:white; }
  </style>
</head>

<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<!-- D√ñNT≈ê GOMBOK ‚Äì CSAK A MEGRENDEL≈ê L√ÅTJA -->
<div id="decision-buttons" style="display:none;">
  <button id="btn-choose">Ezt a szakit v√°lasztom</button>
  <button id="btn-reject">M√°sik szakit v√°lasztottam</button>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>


<script type="module">

  import { app, db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // -------------------------------------------------------------
  // PARAM√âTEREK
  // -------------------------------------------------------------
  const params = new URLSearchParams(window.location.search);

  const USER_NAME = params.get("sender") || prompt("Neved:") || "Ismeretlen";
  const PARTNER_NAME = params.get("partner") || "Ismeretlen";
  const MEGRENDELO_NEV = params.get("megrendelonev") || "";

  localStorage.setItem("szakiName", USER_NAME);

  const ROOM_ID = createRoomId(USER_NAME, PARTNER_NAME);

  // -------------------------------------------------------------
  // F≈ê FEJL√âC
  // -------------------------------------------------------------
  document.getElementById("top-bar").innerHTML = `
    <div class="top-row">
      <div><b>Te:</b> ${USER_NAME}</div>
      <div><b>Partner:</b> ${PARTNER_NAME}</div>
      <div><b>Szoba:</b> ${ROOM_ID}</div>
    </div>
  `;

  // -------------------------------------------------------------
  // MEGOSZT√ÅS SZ√ÅML√ÅL√ì
  // -------------------------------------------------------------
  let sharedCount = Number(localStorage.getItem(USER_NAME + "_share") || 0);

  function addShare(){
      sharedCount++;
      localStorage.setItem(USER_NAME + "_share", sharedCount);
      alert("K√∂sz√∂nj√ºk a megoszt√°st! (" + sharedCount + "/5)");
  }
  window.addShare = addShare;

  // -------------------------------------------------------------
  // FIRESTORE HIVATKOZ√ÅSOK
  // -------------------------------------------------------------
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  try { await updateDoc(chatRef, { lastMessageAt: serverTimestamp() }); } catch(e){}

  // -------------------------------------------------------------
  // MEGRENDEL≈ê ‚Üí L√ÅTJA A D√ñNT≈ê GOMBOKAT
  // -------------------------------------------------------------
  if (MEGRENDELO_NEV && USER_NAME === MEGRENDELO_NEV) {
      document.getElementById("decision-buttons").style.display = "flex";
  }

  // -------------------------------------------------------------
  // FIRESTORE K√úLD√âS
  // -------------------------------------------------------------
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
          const msg = docSnap.data();

          const line = document.createElement("p");
          line.className = "msg";

          const own = msg.senderName === USER_NAME ? "own" : "";
          const time = formatTimestamp(msg.timestamp);

          line.innerHTML =
            `<span class="${own}">${msg.senderName}:</span> ` +
            `${escapeHtml(msg.text)} <span class="meta">(${time})</span>`;

          chatBox.appendChild(line);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  // -------------------------------------------------------------
  // TILTOTT TARTALMAK
  // -------------------------------------------------------------
  function isContactInfo(text){
      const phone = /(06\d{1,}|(\+36)\d{1,})/g;
      const email = /\S+@\S+\.\S+/g;
      const link = /(facebook|instagram|wa\.me|viber|t\.me|mailto|tel:)/g;

      return phone.test(text) || email.test(text) || link.test(text);
  }

  function canSendContact(){ return sharedCount >= 5; }

  // -------------------------------------------------------------
  // √úZENET K√úLD√âS
  // -------------------------------------------------------------
  document.getElementById("send-btn").onclick = sendMsg;
  document.getElementById("message-input").onkeydown = e => { if (e.key === "Enter") sendMsg(); };

  async function sendMsg(){
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;

      if (isContactInfo(text) && !canSendContact()) {
          showWarning();
          input.value = "";
          return;
      }

      try{
        await addDoc(messagesRef,{
            senderName: USER_NAME,
            text,
            timestamp: serverTimestamp()
        });
      }catch(e){
        alert("Hiba √ºzenet k√ºld√©sekor!");
      }

      input.value = "";
  }

  function showWarning(){
      const w = document.createElement("div");
      w.className = "warning-msg";
      w.innerHTML = `
        Kedves szaki/megrendel≈ë!<br><br>
        Az√©rt haszn√°lhatod ingyen az oldalt, mert itt a <b>CHAT-en</b> besz√©ltek meg mindent.<br><br>
        <b>5 MEGOSZT√ÅS ut√°n</b> engedj√ºk az el√©rhet≈ës√©geket.<br><br>
        K√∂sz√∂nj√ºk! üôè
      `;
      chatBox.appendChild(w);
      chatBox.scrollTop = chatBox.scrollHeig
  }

  // -------------------------------------------------------------
  // SZAKI KIV√ÅLASZT√ÅSA / ELUTAS√çT√ÅSA
  // -------------------------------------------------------------
  document.getElementById("btn-choose").onclick = chooseWorker;
  document.getElementById("btn-reject").onclick = rejectWorker;

  async function chooseWorker() {
      try{
          await addDoc(messagesRef,{
              senderName:"Rendszer",
              text:"A megrendel≈ë t√©ged v√°lasztott!",
              timestamp:serverTimestamp()
          });

          document.getElementById("decision-buttons").style.display = "none";
          alert("Kiv√°lasztva.");
      }catch(e){ alert("Hiba."); }
  }

  async function rejectWorker() {
      try{
          await addDoc(messagesRef,{
              senderName:"Rendszer",
              text:"Sajn√°ljuk, a megrendel≈ë nem t√©ged v√°lasztott.",
              timestamp:serverTimestamp()
          });

          document.getElementById("decision-buttons").style.display = "none";
          alert("Elutas√≠tva.");
      }catch(e){ alert("Hiba."); }
  }

  // -------------------------------------------------------------
  // SEG√âDEK
  // -------------------------------------------------------------
  function createRoomId(a,b){
      const x=(a||"").trim().toLowerCase();
      const y=(b||"").trim().toLowerCase();
      return [x,y].sort().join("__");
  }

  function escapeHtml(s){
      const div=document.createElement("div");
      div.innerText=s;
      return div.innerHTML;
  }

  function formatTimestamp(ts){
      const d = ts?.toDate ? ts.toDate() : new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function pad(n){ return n<10 ? "0"+n : n; }

</script>

</body>
</html>

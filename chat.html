<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00;
      padding:12px 16px;
      color:#fff;
      font-weight:bold;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .top-bar {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:10px 14px;
      font-size:13px;
      border-bottom:1px solid #eee;
    }

    .top-row { display:flex; gap:16px; flex-wrap:wrap; }
    .top-row b { font-weight:bold; }

    .back-link {
      display:inline-block;
      margin-top:6px;
      font-size:13px;
      color:#007bff;
      text-decoration:none;
    }
    .back-link span { margin-right:4px; }

    #chat-box {
      max-width:900px;
      margin:12px auto;
      padding:12px 14px;
      background:white;
      border-radius:10px;
      height:55vh;
      overflow-y:auto;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg { margin:6px 0; font-size:14px; }
    .meta { color:#777; font-size:11px; margin-left:6px; }
    .own { font-weight:bold; }
    .del { margin-left:10px; color:#c00; cursor:pointer; font-size:11px; }

    .status-bar {
      max-width:900px;
      margin:0 auto 4px;
      padding:0 14px;
      font-size:11px;
      color:#666;
    }

    .input-row {
      max-width:900px;
      margin:0 auto 14px;
      display:flex;
      gap:8px;
      padding:0 14px;
    }

    #message-input {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .send-btn {
      padding:10px 18px;
      border:none;
      border-radius:8px;
      background:#ff8c00;
      color:white;
      font-size:14px;
      font-weight:bold;
      cursor:pointer;
      white-space:nowrap;
    }

    .send-btn:active {
      transform:translateY(1px);
      filter:brightness(0.95);
    }

    .notify {
      display:none;
      font-size:11px;
      color:#28a745;
    }
    .notify-dot {
      width:8px; height:8px; border-radius:50%;
      background:#28a745; display:inline-block; margin-left:4px;
      animation:blink 1s infinite;
    }
    @keyframes blink { 50% { opacity:0.1; } }
  </style>
</head>
<body>
  <header>Chat ‚Äì Szaki-App</header>

  <div class="top-bar" id="top-bar">
    <!-- ide √≠rjuk ki: Megrendel≈ë, Szakember, Te most -->
  </div>

  <div id="chat-box">
    <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
  </div>

  <div class="status-bar">
    <span id="room-status"></span>
    <span id="notify-indicator" class="notify">
      √öj √ºzenet <span class="notify-dot"></span>
    </span>
  </div>

  <div class="input-row">
    <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
    <button class="send-btn" id="send-btn">K√ºld√©s</button>
  </div>

  <script type="module">
    import { app, db } from "./firebase-config.js";
    import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);

    // Ki vagy most te?
    let USER_NAME = params.get("sender") || localStorage.getItem("szakiName");
    if (!USER_NAME) {
      USER_NAME = prompt("Add meg a neved:") || "Ismeretlen";
    }
    localStorage.setItem("szakiName", USER_NAME);

    // Partner (szakember neve az URL-ben)
    const PARTNER_NAME = params.get("partner") || "Ismeretlen szakember";

    // Megrendel≈ë neve (k√ºl√∂n param√©ter)
    const MEGRENDELO_NEV = params.get("megrendelonev") || "";

    // Szakma (ha √°tj√∂n az URL-ben)
    const SZAKMA = params.get("szakma") || "";

    // Szoba azonos√≠t√≥:
    // ha van megrendel≈ë + szakember, akkor ezekb≈ël sz√°moljuk,
    // k√ºl√∂nben marad a sender/partner alap√∫ kulcs.
    const ROOM_ID = (() => {
      if (MEGRENDELO_NEV && PARTNER_NAME) {
        return canonicalRoom(MEGRENDELO_NEV, PARTNER_NAME);
      }
      return canonicalRoom(USER_NAME, PARTNER_NAME);
    })();

    // Fejl√©c sz√∂vegek
    const topBar = document.getElementById("top-bar");
    const megrText = MEGRENDELO_NEV || "Ismeretlen megrendel≈ë";
    const szakemberText = PARTNER_NAME;
    const youText = USER_NAME;

    const backBase = "valassz-szakit.html";
    let backHref = backBase;
    const qs = [];
    if (SZAKMA) qs.push("szakma=" + encodeURIComponent(SZAKMA));
    if (MEGRENDELO_NEV) qs.push("megrendelonev=" + encodeURIComponent(MEGRENDELO_NEV));
    if (qs.length) backHref += "?" + qs.join("&");

    topBar.innerHTML = `
      <div class="top-row">
        <div><b>Megrendel≈ë:</b> ${escapeHtml(megrText)}</div>
        <div><b>Szakember:</b> ${escapeHtml(szakemberText)}</div>
        <div><b>Te most:</b> ${escapeHtml(youText)}</div>
      </div>
      <a class="back-link" href="${backHref}">
        <span>‚óÄ</span>Vissza a keres√©shez
      </a>
    `;

    // st√°tusz sor
    document.getElementById("room-status").textContent =
      `Szoba: ${ROOM_ID}`;

    // Firestore referenci√°k
    const chatRef = doc(db, "chats", ROOM_ID);
    const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

    // pr√≥b√°ljuk a chat dokumentumot √©letben tartani
    try {
      await updateDoc(chatRef, {
        members: {
          roomId: ROOM_ID,
          megrendelo: MEGRENDELO_NEV || null,
          szakember: PARTNER_NAME || null
        },
        status: "active",
        lastMessageAt: serverTimestamp()
      });
    } catch (_) {
      // ha m√©g nincs dokumentum, majd az els≈ë √ºzenet hozza l√©tre
    }

    // √úzenetek figyel√©se
    let lastSeen = Date.now();
    const chatBox = document.getElementById("chat-box");
    const q = query(messagesRef, orderBy("timestamp"));

    onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        if (Array.isArray(msg.deletedBy) && msg.deletedBy.includes(USER_NAME)) {
          return;
        }
        const p = document.createElement("p");
        p.className = "msg";
        const own = msg.senderName === USER_NAME ? "own" : "";
        const time = formatTs(msg.timestamp);
        p.innerHTML =
          `<span class="${own}">${escapeHtml(msg.senderName)}:</span> ` +
          `${escapeHtml(msg.text || "")}` +
          ` <span class="meta">(${time})</span>`;

        if (msg.senderName === USER_NAME) {
          const del = document.createElement("span");
          del.className = "del";
          del.textContent = "t√∂rl√©s";
          del.onclick = async () => {
            await updateDoc(docSnap.ref, {
              deletedBy: (msg.deletedBy || []).concat(USER_NAME)
            });
          };
          p.appendChild(del);
        }

        chatBox.appendChild(p);
      });

      chatBox.scrollTop = chatBox.scrollHeight;

      const newest = snapshot.docs[snapshot.docs.length - 1];
      if (newest) {
        const ts = newest.data().timestamp?.toMillis?.() || Date.now();
        if (ts > lastSeen) {
          showNotify();
          lastSeen = ts;
        }
      }
    });

    // K√ºld√©s
    const sendBtn = document.getElementById("send-btn");
    const inputField = document.getElementById("message-input");

    sendBtn.addEventListener("click", () => internalSendMessage());
    inputField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        internalSendMessage();
      }
    });

    async function internalSendMessage() {
      const text = inputField.value.trim();
      if (!text) return;
      try {
        await addDoc(messagesRef, {
          senderName: USER_NAME,
          text,
          timestamp: serverTimestamp(),
          deletedBy: [],
          readBy: [USER_NAME]
        });
        await updateDoc(chatRef, { lastMessageAt: serverTimestamp() });
        inputField.value = "";
        hideNotify();
      } catch (err) {
        console.error("Hiba √ºzenet ment√©skor:", err);
        alert("Hiba t√∂rt√©nt az √ºzenet k√ºld√©se k√∂zben.");
      }
    }

    // Seg√©dek
    function canonicalRoom(a, b) {
      const x = (a || "").trim().toLowerCase();
      const y = (b || "").trim().toLowerCase();
      return [x, y].sort().join("__");
    }

    function formatTs(ts) {
      try {
        const d = ts?.toDate ? ts.toDate() : new Date();
        return `${pad(d.getHours())}:${pad(d.getMinutes())} ` +
               `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`;
      } catch { return "id≈ëb√©lyeg"; }
    }
    function pad(n) { return n < 10 ? "0"+n : ""+n; }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.innerText = s == null ? "" : String(s);
      return div.innerHTML;
    }

    function showNotify() {
      const el = document.getElementById("notify-indicator");
      el.style.display = "inline";
      document.title = "üîî √öj √ºzenet ‚Äì Szaki-App";
    }
    function hideNotify() {
      const el = document.getElementById("notify-indicator");
      el.style.display = "none";
      document.title = "Chat ‚Äì Szaki-App";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Chat ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            margin:0;
            background:#f5f5f5;
            font-family:Arial, sans-serif;
            display:flex;
            flex-direction:column;
            height:100vh;
        }

        #chatHeader {
            background:#007aff;
            color:white;
            padding:14px;
            font-size:18px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        #messages {
            flex:1;
            overflow-y:auto;
            padding:16px;
        }

        .msg {
            max-width:75%;
            padding:10px 14px;
            border-radius:12px;
            margin-bottom:12px;
            word-wrap:break-word;
            font-size:15px;
            box-shadow:0 2px 6px rgba(0,0,0,0.08);
        }

        .me { background:#007aff; color:white; margin-left:auto; }
        .other { background:white; color:black; margin-right:auto; }

        #inputBar {
            padding:10px;
            background:white;
            border-top:1px solid #ddd;
            display:flex;
        }

        #msgInput {
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:8px;
        }

        #sendBtn {
            background:#007aff;
            color:white;
            padding:10px 16px;
            border:none;
            border-radius:8px;
            margin-left:8px;
        }

        #lockWarning {
            display:none;
            text-align:center;
            background:#ffe5e5;
            padding:8px;
            color:#a10000;
            font-weight:bold;
        }
    </style>
</head>

<body>

<div id="chatHeader">
    <div id="partnerName">Chat</div>
    <div id="partnerStatus">‚ö™</div>
</div>

<div id="lockWarning">üîí El√©rhet≈ës√©g k√ºld√©se z√°rolva 5 megoszt√°s alatt!</div>

<div id="messages">Bet√∂lt√©s...</div>

<div id="inputBar">
    <input id="msgInput" type="text" placeholder="√çrj √ºzenetet...">
    <button id="sendBtn">K√ºld√©s</button>
</div>

<!-- ‚ù§Ô∏è T√°mogat√°s -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
     <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>

<script type="module">

/* FIREBASE */
import { db, auth } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    doc, getDoc, setDoc, updateDoc,
    collection, addDoc, query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


// ----------------------------------------------------------------
// URL PARAM√âTEREK
// ----------------------------------------------------------------
const params = new URLSearchParams(window.location.search);
const chatID = params.get("chatID");
const partnerID = params.get("partner");

let uid = null;
let userData = null;
let partnerData = null;


// ----------------------------------------------------------------
// AUTH ‚Üí BET√ñLTJ√úK A SAJ√ÅT ADATOKAT FIRESTOREB≈êL
// ----------------------------------------------------------------
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    uid = user.uid;

    const meRef = doc(db, "users", uid);
    const meSnap = await getDoc(meRef);
    userData = meSnap.data();

    const pRef = doc(db, "users", partnerID);
    const pSnap = await getDoc(pRef);
    partnerData = pSnap.data();

    // Fejl√©c friss√≠t√©se
    document.getElementById("partnerName").innerText =
        partnerData.displayName || partnerData.name || partnerData.email;

    document.getElementById("partnerStatus").innerText =
        partnerData.online ? "üü¢" : "‚ö™";

    loadMessages();
});


// ----------------------------------------------------------------
// √úZENETEK REALTIME BET√ñLT√âSE FIRESTORE-B√ìL
// ----------------------------------------------------------------
function loadMessages() {
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "Bet√∂lt√©s...";

    const q = query(
        collection(db, "chats", chatID, "messages"),
        orderBy("timestamp", "asc")
    );

    onSnapshot(q, (snap) => {
        msgBox.innerHTML = "";

        snap.forEach((d) => {
            const m = d.data();

            const div = document.createElement("div");
            div.className = "msg " + (m.sender === uid ? "me" : "other");
            div.innerText = m.text;

            msgBox.appendChild(div);
        });

        msgBox.scrollTop = msgBox.scrollHeight;
    });
}


// ----------------------------------------------------------------
// √úZENET K√úLD√âSE
// ----------------------------------------------------------------
document.getElementById("sendBtn").onclick = sendMessage;

document.getElementById("msgInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;

    // 5 MEGOSZT√ÅS ALATT TILTJUK A TELEFON / EMAIL FORM√ÅKAT
    if (userData?.shareCount < 5 && looksLikeContact(text)) {
        document.getElementById("lockWarning").style.display = "block";
        return;
    }

    await addDoc(collection(db, "chats", chatID, "messages"), {
        text,
        sender: uid,
        timestamp: Date.now()
    });

    await updateDoc(doc(db, "chats", chatID), {
        lastMessage: text,
        lastTimestamp: Date.now()
    });

    input.value = "";
}


// ----------------------------------------------------------------
// TELEFON / EMAIL mint√°k
// ----------------------------------------------------------------
function looksLikeContact(text) {
    // telefonsz√°m
    if (/[0-9]{6,}/.test(text)) return true;

    // email c√≠m
    if (text.includes("@")) return true;

    return false;
}

</script>

</body>
</html>

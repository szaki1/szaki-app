<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }

    header {
      background:#ff8c00; padding:12px 16px; color:#fff;
      font-weight:bold; font-size:18px; text-align:center;
    }

    .top-bar{
      max-width:900px; margin:0 auto; background:white;
      padding:10px 14px; border-bottom:1px solid #eee; font-size:13px;
    }
    .top-row{ display:flex; flex-wrap:wrap; gap:16px; }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .warning-msg{
      margin:6px 0; padding:10px; background:#fff7e1;
      border-left:4px solid #ff8c00; border-radius:6px;
      font-size:13px; color:#8a5a00;
    }

    .input-row{
      max-width:900px; margin:0 auto 14px; padding:0 14px;
      display:flex; gap:8px;
    }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }

    /* Szaki v√°laszt√≥ gombok */
    #select-buttons{
      max-width:900px; margin:10px auto; display:flex;
      gap:10px; padding:0 14px;
    }

    #select-worker{
      flex:1; padding:12px; background:#28a745; color:white;
      border:none; border-radius:8px; font-weight:bold; cursor:pointer;
    }

    #select-other{
      flex:1; padding:12px; background:#c00; color:white;
      border:none; border-radius:8px; font-weight:bold; cursor:pointer;
    }
  </style>
</head>

<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<!-- SZAKI V√ÅLASZT√ÅS GOMBOK -->
<div id="select-buttons">
  <button id="select-worker">Ezt a szakit v√°lasztom</button>
  <button id="select-other">M√°sik szakit v√°lasztottam</button>
</div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>

<script type="module">

  import { app, db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // -------------------------------------------------------------
  // URL PARAM√âTEREK
  // -------------------------------------------------------------
  const params = new URLSearchParams(window.location.search);

  const USER_NAME = params.get("sender");
  const PARTNER_NAME = params.get("partner");
  const ORDER_ID = params.get("orderId");   // <<< ORDER ID BE√âP√çTVE !!! >>>

  if (!USER_NAME || !PARTNER_NAME || !ORDER_ID) {
      alert("Hib√°s chat hivatkoz√°s! (hi√°nyzik: sender, partner vagy orderId)");
  }

  const ROOM_ID = createRoomId(USER_NAME, PARTNER_NAME);

  // -------------------------------------------------------------
  // HELYI MEGOSZT√ÅS SZ√ÅML√ÅL√ì
  // -------------------------------------------------------------
  let sharedCount = Number(localStorage.getItem(USER_NAME + "_share") || 0);

  function addShare() {
      sharedCount++;
      localStorage.setItem(USER_NAME + "_share", sharedCount);
      alert("K√∂sz√∂nj√ºk a megoszt√°st! (" + sharedCount + "/5)");
  }
  window.addShare = addShare;

  // -------------------------------------------------------------
  // FEJL√âC FELT√ñLT√âSE
  // -------------------------------------------------------------
  document.getElementById("top-bar").innerHTML = `
    <div class="top-row">
      <div><b>Te:</b> ${USER_NAME}</div>
      <div><b>Partner:</b> ${PARTNER_NAME}</div>
      <div><b>Megrendel√©s ID:</b> ${ORDER_ID}</div>
      <button onclick="addShare()">Megosztottam az oldalt</button>
    </div>
  `;

  // -------------------------------------------------------------
  // FIRESTORE ‚Äì CHAT REFERENCIA
  // -------------------------------------------------------------
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  // chat meta adatok friss√≠t√©se
  await setDoc(chatRef, {
      roomId: ROOM_ID,
      orderId: ORDER_ID,           // <<< ORDER_ID HOZZ√ÅADVA !!!
      users: [USER_NAME, PARTNER_NAME],
      lastMessageAt: serverTimestamp(),
      status: "active"
  }, { merge: true });

  // -------------------------------------------------------------
  // √úZENET FIGYEL√âSE
  // -------------------------------------------------------------
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
          const msg = docSnap.data();

          const line = document.createElement("p");
          line.className = "msg";

          const own = msg.senderName === USER_NAME ? "own" : "";
          const time = formatTimestamp(msg.timestamp);

          line.innerHTML =
            `<span class="${own}">${msg.senderName}:</span> ` +
            `${escapeHtml(msg.text)} <span class="meta">(${time})</span>`;

          chatBox.appendChild(line);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  // -------------------------------------------------------------
  // √ºzenet k√ºld√©s
  // -------------------------------------------------------------
  document.getElementById("send-btn").onclick = () => userSendMessage();
  document.getElementById("message-input").onkeydown = (e) => {
      if (e.key === "Enter") userSendMessage();
  };

  async function userSendMessage() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;

      // tiltott tartalom ellen≈ërz√©se
      if (isContactInfo(text) && sharedCount < 5) {
          showWarning();
          input.value = "";
          return;
      }

      await addDoc(messagesRef, {
          senderName: USER_NAME,
          text,
          timestamp: serverTimestamp()
      });

      await updateDoc(chatRef, { lastMessageAt: serverTimestamp() });

      input.value = "";
  }

  // -------------------------------------------------------------
  // SZAKI KIV√ÅLASZT√ÅSA VAGY ELUTAS√çT√ÅSA
  // -------------------------------------------------------------
  document.getElementById("select-worker").onclick = async () => {
      await updateDoc(chatRef, {
          status: "selected",
          selectedBy: USER_NAME,
          selectedAt: serverTimestamp()
      });

      alert("Kiv√°lasztottad ezt a szakit! üëç");
      document.getElementById("select-buttons").style.display = "none";
  };

  document.getElementById("select-other").onclick = async () => {

      // szakinak √ºzenet k√ºld√©se
      await addDoc(messagesRef, {
          senderName: "Rendszer",
          text: "Sajnos nem t√©ged v√°lasztott a megrendel≈ë.",
          timestamp: serverTimestamp()
      });

      await updateDoc(chatRef, {
          status: "rejected",
          rejectedAt: serverTimestamp()
      });

      alert("Visszajelz√©s elk√ºldve!");

      document.getElementById("select-buttons").style.display = "none";
  };

  // -------------------------------------------------------------
  // SEG√âDF√úGGV√âNYEK
  // -------------------------------------------------------------
  function isContactInfo(text) {
      const phoneRegex = /(06\d{1,}|(\+36)\d{1,})/g;
      const emailRegex = /\S+@\S+\.\S+/g;
      return phoneRegex.test(text) || emailRegex.test(text);
  }

  function showWarning() {
      const warn = document.createElement("div");
      warn.className = "warning-msg";
      warn.innerHTML = `
        Kedves szaki/megrendel≈ë!<br><br>
        <b>El√©rhet≈ës√©get csak 5 megoszt√°s ut√°n enged√ºnk.</b><br><br>
        K√∂sz√∂nj√ºk a t√°mogat√°st! üôè
      `;
      chatBox.appendChild(warn);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

  function createRoomId(a, b) {
      return [a.toLowerCase(), b.toLowerCase()].sort().join("__");
  }

  function escapeHtml(s) {
      const div = document.createElement("div");
      div.innerText = s;
      return div.innerHTML;
  }

  function formatTimestamp(ts) {
      try {
          const d = ts?.toDate ? ts.toDate() : new Date();
          return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch { return ""; }
  }

  function pad(n){ return n<10 ? "0"+n : n; }

</script>

</body>
</html>

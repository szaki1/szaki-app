<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Chat ‚Äì Szaki-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }
    header { background:#ff8c00; padding:12px 16px; color:#fff;
             font-weight:bold; font-size:18px; text-align:center; }

    .top-bar { max-width:900px; margin:0 auto; background:white;
               padding:10px 14px; border-bottom:1px solid #eee; font-size:13px; }

    #chat-box{
      max-width:900px; margin:12px auto; padding:12px 14px;
      background:white; border-radius:10px;
      height:55vh; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .msg{ margin:6px 0; font-size:14px; }
    .own{ font-weight:bold; }
    .meta{ font-size:11px; color:#777; margin-left:6px; }

    .input-row{ max-width:900px; margin:0 auto 14px; padding:0 14px;
                display:flex; gap:8px; }

    #message-input{
      flex:1; padding:10px; border-radius:8px;
      border:1px solid #ccc; font-size:14px;
    }

    .send-btn{
      padding:10px 18px; background:#ff8c00; border:none;
      border-radius:8px; color:white; font-weight:bold;
      cursor:pointer;
    }

  </style>
</head>

<body>

<header>Chat ‚Äì Szaki-App</header>

<div class="top-bar" id="top-bar"></div>

<div id="chat-box">
  <p><i>Csatlakozt√°l a besz√©lget√©shez‚Ä¶</i></p>
</div>

<div class="input-row">
  <input type="text" id="message-input" placeholder="√çrj √ºzenetet‚Ä¶" />
  <button class="send-btn" id="send-btn">K√ºld√©s</button>
</div>

<script type="module">

  /* ============================================
     FIREBASE
  ============================================= */
  import { db } from "./firebase-config.js";
  import {
      collection, doc, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  /* ============================================
     PARAM√âTEREK
  ============================================= */
  const params = new URLSearchParams(window.location.search);

  let USER_NAME = params.get("sender") || localStorage.getItem("szakiName");
  const PARTNER_NAME = params.get("partner") || "Ismeretlen";
  const ORDER_ID = params.get("orderId") || null;

  if (!USER_NAME) {
      USER_NAME = prompt("Add meg a neved:") || "Ismeretlen";
      localStorage.setItem("szakiName", USER_NAME);
  }

  // --- √Ål-szaki felismer√©s ---
  const isFakeWorker =
      PARTNER_NAME !== "Csabi" &&
      PARTNER_NAME !== "Zsolti" &&
      !PARTNER_NAME.toLowerCase().includes("admin");

  let fakeMessageCount = 0;

  const ROOM_ID = [USER_NAME.toLowerCase(), PARTNER_NAME.toLowerCase()].sort().join("__");

  document.getElementById("top-bar").innerHTML =
    `<b>Te:</b> ${USER_NAME} &nbsp; | &nbsp;
     <b>Szakember:</b> ${PARTNER_NAME}
     ${ORDER_ID ? ` | <b>Munka azonos√≠t√≥:</b> ${ORDER_ID}` : ""}`;

  /* ============================================
     FIRESTORE REFERENCI√ÅK
  ============================================= */
  const chatRef = doc(db, "chats", ROOM_ID);
  const messagesRef = collection(db, "chats", ROOM_ID, "uzenetek");

  try {
      await updateDoc(chatRef, {
          roomId: ROOM_ID,
          members: { you: USER_NAME, partner: PARTNER_NAME, orderId: ORDER_ID },
          status: "active",
          lastMessageAt: serverTimestamp()
      });
  } catch (e) {}

  /* ============================================
     CHAT LISTENER
  ============================================= */
  const chatBox = document.getElementById("chat-box");
  const q = query(messagesRef, orderBy("timestamp"));

  onSnapshot(q, (snap) => {
      chatBox.innerHTML = "";
      snap.forEach(m => {
          const d = m.data();
          const p = document.createElement("p");
          p.className = "msg";

          const own = d.senderName === USER_NAME ? "own" : "";
          const time = d.timestamp?.toDate().toLocaleTimeString("hu-HU",
                      {hour:"2-digit",minute:"2-digit"});

          p.innerHTML =
            `<span class="${own}">${d.senderName}:</span> ` +
            `${escapeHtml(d.text)} <span class="meta">(${time})</span>`;

          chatBox.appendChild(p);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
  });

  /* ============================================
     √úZENET K√úLD√âS
  ============================================= */
  document.getElementById("send-btn").onclick = sendMsg;
  document.getElementById("message-input").onkeydown = e => {
      if (e.key === "Enter") sendMsg();
  };

  async function sendMsg() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text) return;

      await addDoc(messagesRef, {
          senderName: USER_NAME,
          text,
          timestamp: serverTimestamp()
      });

      await updateDoc(chatRef, { lastMessageAt: serverTimestamp() });

      input.value = "";

      // √°l-szaki v√°lasz
      if (isFakeWorker) {
          handleFakeWorkerReply();
      }
  }

  /* ============================================
     √ÅLSZAKI AI V√ÅLASZOK
  ============================================= */
  const fakeReplies = [
      "Szia! K√∂szi, hogy √≠rt√°l! Most sajnos teljesen tele vagyok, nem tudok √∫j munk√°t v√°llalni.",
      "√údv! Nagyon sajn√°lom, de √©pp be vagyok t√°bl√°zva. Rem√©lem tal√°lsz gyorsan szakembert!",
      "Szia! Most nincs kapacit√°som √∫j munk√°ra, ne haragudj.",
      "K√∂sz√∂n√∂m az √ºzenetet! Most √©pp nem tudok t√∂bb feladatot v√°llalni.",
      "Hell√≥! Jelenleg mindent bet√°bl√°ztam, sajn√°lom."
  ];

  const byeReplies = [
      "Tov√°bbi sz√©p napot k√≠v√°nok! üòä",
      "Sok sikert a munk√°hoz! üôÇ",
      "Sz√©p napot, √©s k√∂szi a megkeres√©st!",
      "Vigy√°zz magadra, sz√©p napot!",
      "K√∂sz√∂n√∂m m√©g egyszer, viszl√°t!"
  ];

  async function handleFakeWorkerReply() {

      fakeMessageCount++;

      // 1. √ºzenet ‚Äì udvarias elutas√≠t√°s
      if (fakeMessageCount === 1) {
          const msg = fakeReplies[Math.floor(Math.random() * fakeReplies.length)];

          await addDoc(messagesRef, {
              senderName: PARTNER_NAME,
              text: msg,
              timestamp: serverTimestamp()
          });
          return;
      }

      // 2. √ºzenet ‚Äì elk√∂sz√∂n√©s
      if (fakeMessageCount === 2) {
          const msg = byeReplies[Math.floor(Math.random() * byeReplies.length)];

          await addDoc(messagesRef, {
              senderName: PARTNER_NAME,
              text: msg,
              timestamp: serverTimestamp()
          });

          // kil√©p√©s jelz√©se
          await addDoc(messagesRef, {
              senderName: "Rendszer",
              text: `${PARTNER_NAME} kil√©pett a besz√©lget√©sb≈ël.`,
              timestamp: serverTimestamp()
          });

          return;
      }
  }

  /* ============================================
     SEG√âD ‚Äì HTML sanitization
  ============================================= */
  function escapeHtml(s){
      const div = document.createElement("div");
      div.innerText = s;
      return div.innerHTML;
  }

</script>

</body>
</html>

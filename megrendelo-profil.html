<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Megrendel≈ë profil ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Glob√°lis st√≠lus -->
    <link rel="stylesheet" href="style.css">

    <style>
        header {
            background:#007aff; 
            color:white; 
            padding:16px;
            text-align:center; 
            font-size:20px; 
            font-weight:bold;
        }

        .box {
            background:white; 
            border-radius:12px; 
            padding:18px;
            box-shadow:0 2px 10px rgba(0,0,0,0.08);
            margin:14px;
        }

        .infoText {
            padding:10px 0; 
            font-size:18px; 
            font-weight:bold;
        }

        input, select {
            width:100%; padding:12px; 
            border-radius:8px;
            border:1px solid #ccc; 
            margin-top:8px; 
            font-size:16px;
            box-sizing: border-box;
        }

        .btn {
            width:100%; 
            padding:12px; 
            margin-top:12px;
            background:#007aff; 
            color:white; 
            border:none;
            border-radius:8px; 
            cursor:pointer; 
            font-size:16px;
            font-weight:bold;
        }

        .btn:hover { transform:scale(1.03); }

        .profession-item {
            padding:10px;
            border-bottom:1px solid #f0f0f0;
            cursor:pointer;
            transition: 0.15s;
        }

        .profession-item:hover {
            background:#f9f9f9;
        }

        .message-item {
            padding:10px;
            border-bottom:1px solid #eee;
            cursor:pointer;
            transition: 0.15s;
        }

        .message-item:hover {
            background:#f5f5f5;
        }

        .profile-field {
            margin-bottom:10px;
        }
    </style>
</head>

<body>

<header>Megrendel≈ë ‚Äì Profil</header>

<div class="container">

    <!-- BEJ√ñV≈ê √úZENETEK -->
    <div class="box">
        <b>üì© Bej√∂v≈ë √ºzenetek</b>
        <div id="incomingMessages" class="infoText" style="margin-top:12px; font-size:16px;">0</div>
        <div id="messagesList" style="margin-top:12px; max-height:300px; overflow-y:auto;"></div>
    </div>

    <!-- SZAKMA V√ÅLASZT√ÅS -->
    <div class="box">
        <b>‚öôÔ∏è SZAKMA V√ÅLASZT√ÅS</b>
        <input id="professionSearch" type="text" placeholder="Keres√©s n√©v, v√°ros vagy ker√ºlet szerint..." style="margin-top:8px;">
        <div id="professionDropdown" style="margin-top:12px; max-height:280px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:0;">
            <div style="text-align:center; color:#999; padding:20px;">Bet√∂lt√©s...</div>
        </div>
    </div>

    <!-- PROFIL ADATOK -->
    <div class="box">
        <b>Profil adatok</b>
        <div style="margin-top:12px;">
            <div class="profile-field">
                <b>N√©v:</b> <span id="nameDisplay">Bet√∂lt√©s...</span>
            </div>
            <div class="profile-field">
                <b>Email:</b> <span id="emailDisplay">Bet√∂lt√©s...</span>
            </div>
            <div class="profile-field">
                <b>Telefonsz√°m:</b> <span id="phoneDisplay">Bet√∂lt√©s...</span>
            </div>
            <div class="profile-field">
                <b>V√°ros:</b> <span id="cityDisplay">Bet√∂lt√©s...</span>
            </div>
        </div>
    </div>

    <!-- V√ÅROS SZERKESZT√âS -->
    <div class="box">
        <b>Hol keresel szakembert?</b>
        <select id="citySelect">
            <option value="">V√°lassz v√°rost</option>
            <option>Budapest</option>
            <option>G√∂d√∂ll≈ë</option>
            <option>V√°c</option>
            <option>Kecskem√©t</option>
            <option>Debrecen</option>
            <option>Szeged</option>
            <option>P√©cs</option>
            <option>Gy≈ër</option>
        </select>
        <button class="btn" id="saveCityBtn">V√°ros ment√©se</button>
    </div>

    <!-- MEGOSZT√ÅS -->
    <div class="box">
        <b>Megoszt√°sok sz√°ma:</b>
        <div id="shareCountBox" class="infoText">0 / 5</div>
        <button class="btn" id="addShareBtn">Megosztottam! (+1)</button>

        <p id="unlockInfo" style="margin-top:10px; font-size:14px;"></p>
    </div>

    <!-- KIL√âP√âS -->
    <div class="box">
        <button class="btn" id="logoutBtn" style="background:#444;">Kil√©p√©s</button>
    </div>

</div>

<!-- ‚ù§Ô∏è T√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogat√°s
</div>

<script type="module">
/* ============================================================
   FIREBASE IMPORT
============================================================ */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    doc, getDoc, updateDoc, getDocs, collection, query, where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ============================================================
   FELHASZN√ÅL√ì BET√ñLT√âSE
============================================================ */
let uid = null;
let shareCount = 0;
let city = "";

onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    uid = user.uid;

    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) return;

    const data = snap.data();

    // Profil adatok megjelen√≠t√©se
    document.getElementById("nameDisplay").innerText = data.name || "Nincs n√©v";
    document.getElementById("emailDisplay").innerText = data.email || "Nincs email";
    document.getElementById("phoneDisplay").innerText = data.phone || "Nincs telefonsz√°m";
    document.getElementById("cityDisplay").innerText = data.city || "Nincs v√°ros";

    shareCount = data.shareCount || 0;
    city = data.city || "";

    if (city) document.getElementById("citySelect").value = city;

    updateShareUI();
    loadIncomingMessages();
    loadProfessions();
});


/* ============================================================
   V√ÅROS MENT√âSE
============================================================ */
document.getElementById("saveCityBtn").onclick = async () => {
    const selected = document.getElementById("citySelect").value;
    if (!selected) return alert("V√°lassz v√°rost!");

    await updateDoc(doc(db, "users", uid), { city: selected });
    alert("V√°ros mentve!");
};


/* ============================================================
   MEGOSZT√ÅS +1
============================================================ */
document.getElementById("addShareBtn").onclick = async () => {
    if (shareCount < 5) shareCount++;

    await updateDoc(doc(db, "users", uid), { shareCount });

    updateShareUI();
};


/* ============================================================
   UI FRISS√çT√âS
============================================================ */
function updateShareUI() {
    document.getElementById("shareCountBox").innerText = `${shareCount} / 5`;

    if (shareCount >= 5) {
        document.getElementById("unlockInfo").innerHTML =
            "<b style='color:green;'>Feloldva! K√ºldhetsz telefonsz√°mot a chatben.</b>";
    } else {
        document.getElementById("unlockInfo").innerHTML =
            "<span style='color:red;'>El√©rhet≈ës√©g k√ºld√©se z√°rolva (min. 5 megoszt√°s).</span>";
    }
}


/* ============================================================
   KIL√âP√âS
============================================================ */
document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    window.location.href = "login.html";
};


/* ============================================================
   BEJ√ñV≈ê √úZENETEK BET√ñLT√âSE
============================================================ */
async function loadIncomingMessages() {
    const q = query(
        collection(db, "chats"),
        where("userID", "==", uid)
    );

    const snap = await getDocs(q);
    const messagesList = document.getElementById("messagesList");
    const incomingCount = document.getElementById("incomingMessages");

    if (snap.empty) {
        messagesList.innerHTML = "<i style='color:#999;'>Nincs bej√∂v≈ë √ºzenet.</i>";
        incomingCount.innerText = "0";
        return;
    }

    incomingCount.innerText = snap.size;
    messagesList.innerHTML = "";

    snap.forEach(async (docu) => {
        const c = docu.data();
        const sRef = doc(db, "users", c.szakiID);
        const sSnap = await getDoc(sRef);
        const szaki = sSnap.data();

        const online = szaki.online ? "üü¢ Online" : "‚ö™ Offline";

        messagesList.innerHTML += `
            <div class="message-item" onclick="openChat('${docu.id}', '${c.szakiID}')">
                <div><b>${szaki.name}</b> <span style="font-size:12px;">${online}</span></div>
                <div style="font-size:13px; color:#666;">${szaki.profession}</div>
            </div>
        `;
    });
}

/* ============================================================
   SZAKM√ÅK BET√ñLT√âSE √âS MEGJELEN√çT√âSE
============================================================ */
let allProfessions = [];

async function loadProfessions() {
    const q = query(collection(db, "users"), where("role", "==", "szaki"));
    const snap = await getDocs(q);

    const professions = new Set();
    snap.forEach((docu) => {
        const data = docu.data();
        if (data.profession) {
            professions.add(data.profession);
        }
    });

    allProfessions = Array.from(professions).sort();
    renderProfessions(allProfessions);
}

function renderProfessions(items) {
    const dropdown = document.getElementById("professionDropdown");

    if (items.length === 0) {
        dropdown.innerHTML = "<div style='padding:10px; color:#999;'>Nincsenek szakm√°k.</div>";
        return;
    }

    dropdown.innerHTML = items.map(p => `
        <div class="profession-item" onclick="selectProfession('${p}')" title="${p}">
            ${p}
        </div>
    `).join("");
}

/* ============================================================
   KERES√âS A SZAKM√ÅK K√ñZ√ñTT
============================================================ */
document.getElementById("professionSearch").oninput = (e) => {
    const searchQuery = e.target.value.toLowerCase();
    const filtered = allProfessions.filter(p => 
        p.toLowerCase().includes(searchQuery)
    );
    renderProfessions(filtered);
};

/* ============================================================
   SZAKMA KIV√ÅLASZT√ÅSA
============================================================ */
window.selectProfession = function(profession) {
    window.location.href = `szakma-valasztas.html?profession=${encodeURIComponent(profession)}`;
};

/* ============================================================
   CHAT MEGNYIT√ÅSA
============================================================ */
window.openChat = function(chatID, szakiID) {
    window.location.href = `chat.html?chatID=${chatID}&partner=${szakiID}&role=megrendelo`;
};
</script>

</body>
</html>

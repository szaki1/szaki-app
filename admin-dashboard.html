<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard – Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin:0;
            padding:0;
            background:#f4f4f4;
            font-family:Arial, sans-serif;
        }

        header {
            background:#ff8c00;
            color:white;
            padding:16px;
            text-align:center;
            font-size:22px;
            font-weight:bold;
        }

        .logout-btn {
            position:fixed;
            top:12px;
            right:12px;
            background:#c00;
            color:white;
            border:none;
            padding:10px 16px;
            border-radius:8px;
            font-weight:bold;
            cursor:pointer;
        }

        .container {
            max-width:1100px;
            margin:20px auto;
            padding:10px;
        }

        .panel {
            background:white;
            padding:18px;
            border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,0.08);
            margin-bottom:22px;
        }

        .panel h2 {
            margin:0 0 12px;
            font-size:18px;
            color:#333;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        th, td {
            border-bottom:1px solid #ddd;
            padding:10px;
            font-size:14px;
        }

        th {
            background:#fafafa;
            text-align:left;
        }

        .online {
            color:#2e8b57;
            font-weight:bold;
        }

        .offline {
            color:#b30000;
            font-weight:bold;
        }

    </style>
</head>

<body>

<header>Admin Dashboard – Szaki-App</header>

<button class="logout-btn" id="logout-btn">Kijelentkezés</button>

<div class="container">

    <!-- PANEL 1 – SZAKIK ONLINE STÁTUSZAI -->
    <div class="panel">
        <h2>Szakik online állapota (élő frissítés)</h2>
        <table id="szakik-table">
            <tr>
                <th>Név</th>
                <th>Szakma</th>
                <th>Utoljára aktív</th>
                <th>Státusz</th>
            </tr>
        </table>
    </div>

    <!-- PANEL 2 – AKTÍV CHAT SZOBÁK -->
    <div class="panel">
        <h2>Aktív chatek</h2>
        <table id="chats-table">
            <tr>
                <th>Szoba ID</th>
                <th>Megrendelő</th>
                <th>Szaki</th>
                <th>Utoljára üzenet</th>
            </tr>
        </table>
    </div>

</div>

<!-- FIREBASE + ADMIN SCRIPT -->
<script type="module">

    import { app, db } from "./firebase-config.js";

    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
        collection,
        query,
        onSnapshot,
        orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // AUTH ellenőrzés
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "admin-login.html";
        }
    });

    // KIJELENTKEZÉS
    document.getElementById("logout-btn").onclick = async () => {
        await signOut(auth);
        window.location.href = "admin-login.html";
    };

    // ---------------------------------------------------------
    // PANEL 1: SZAKIK ONLINE STÁTUSZAI
    // ---------------------------------------------------------

    const szakikTable = document.getElementById("szakik-table");

    const q1 = query(collection(db, "szakik"), orderBy("lastSeen", "desc"));

    onSnapshot(q1, (snapshot) => {
        szakikTable.innerHTML = `
            <tr>
                <th>Név</th>
                <th>Szakma</th>
                <th>Utoljára aktív</th>
                <th>Státusz</th>
            </tr>`;

        snapshot.forEach((doc) => {
            const d = doc.data();
            const last = d.lastSeen?.toDate ? d.lastSeen.toDate() : null;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${d.name}</td>
                <td>${Array.isArray(d.profession) ? d.profession.join(", ") : d.profession || ""}</td>
                <td>${last ? formatDate(last) : "-"}</td>
                <td class="${d.isOnline ? "online" : "offline"}">
                    ${d.isOnline ? "Online" : "Offline"}
                </td>
            `;
            szakikTable.appendChild(tr);
        });
    });

    // ---------------------------------------------------------
    // PANEL 2: AKTÍV CHAT SZOBÁK
    // ---------------------------------------------------------

    const chatsTable = document.getElementById("chats-table");

    const q2 = query(collection(db, "chats"), orderBy("lastMessageAt", "desc"));

    onSnapshot(q2, (snapshot) => {
        chatsTable.innerHTML = `
            <tr>
                <th>Szoba ID</th>
                <th>Megrendelő</th>
                <th>Szaki</th>
                <th>Utoljára üzenet</th>
            </tr>`;

        snapshot.forEach((doc) => {
            const c = doc.data();
            const date = c.lastMessageAt?.toDate ? c.lastMessageAt.toDate() : null;

            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${c.roomId || doc.id}</td>
                <td>${c.members?.megrendelo || "-"}</td>
                <td>${c.members?.szakember || "-"}</td>
                <td>${date ? formatDate(date) : "-"}</td>
            `;

            chatsTable.appendChild(tr);
        });
    });

    // ---------------------------------------------------------
    // Segédfüggvény
    // ---------------------------------------------------------

    function formatDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        const h = String(d.getHours()).padStart(2,"0");
        const min = String(d.getMinutes()).padStart(2,"0");

        return `${y}.${m}.${day} ${h}:${min}`;
    }

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <title>Válassz szakembert – Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body { margin:0; padding:0; background:#f5f5f5; font-family:Arial,sans-serif; }
        header{
            background:#ff8c00; color:white; padding:16px; text-align:center;
            font-size:20px; font-weight:bold;
        }
        .container{ max-width:900px; margin:0 auto; padding:16px; }

        .info-box{
            background:white; padding:14px 16px; border-radius:10px;
            box-shadow:0 2px 8px rgba(0,0,0,0.08); font-size:14px; margin-bottom:16px;
        }

        .szaki-card{
            background:white; border-radius:12px; padding:14px 16px;
            margin-bottom:14px; box-shadow:0 2px 10px rgba(0,0,0,0.08);
        }
        .szaki-name{ font-size:18px; font-weight:bold; }
        .szaki-profession{ font-size:14px; color:#555; margin-top:4px; }
        .actions{ margin-top:14px; display:flex; gap:10px; }

        .btn-choose, .btn-reject, .btn-chat{
            flex:1; padding:10px; border:none; border-radius:8px;
            font-weight:bold; cursor:pointer; color:white; font-size:14px;
        }
        .btn-choose{ background:#28a745; }
        .btn-reject{ background:#c00; }
        .btn-chat{ background:#007bff; }

    </style>
</head>

<body>

<header>Válassz szakembert</header>

<div class="container">

    <div class="info-box" id="info-box"></div>

    <div id="szaki-lista"></div>
</div>

<script src="szaki-adatok.js"></script>
<script src="matching-job-flow.js"></script>

<script type="module">

    import { db } from "./firebase-config.js";
    import {
        doc, setDoc, getDoc, updateDoc,
        collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Matching flow inicializálása
    window.MatchFlow_initFirestore(db);

    // PARAMÉTEREK
    const params = new URLSearchParams(window.location.search);
    const megrendelonev = params.get("name") || "Megrendelő";
    const szakma = params.get("szakma") || "";
    let orderId = params.get("orderId") || null;

    // INFO DOBOZ KITÖLTÉSE
    document.getElementById("info-box").innerHTML = `
        <b>Megrendelő:</b> ${megrendelonev} <br>
        <b>Keresett szakma:</b> ${szakma}
    `;

    // ORDER ID létrehozása ha még nincs
    async function ensureOrderId(){
        if(orderId) return orderId;

        orderId = await window.MatchFlow_createJob(megrendelonev, szakma);

        const newUrl = window.location.pathname +
                       `?name=${encodeURIComponent(megrendelonev)}&szakma=${encodeURIComponent(szakma)}&orderId=${orderId}`;

        window.history.replaceState({}, "", newUrl);
        return orderId;
    }

    await ensureOrderId();

    // SZAKIK KIRAJZOLÁSA
    const lista = document.getElementById("szaki-lista");
    const szakik = window.SzakiAdatok.findByProfession(szakma);

    szakik.forEach(sz => {
        const card = document.createElement("div");
        card.className = "szaki-card";

        card.innerHTML = `
            <div class="szaki-name">${sz.name}</div>
            <div class="szaki-profession">${sz.profession}</div>

            <div class="actions">
                <button class="btn-chat">Chat</button>
                <button class="btn-choose">Ezt a szakit választom</button>
                <button class="btn-reject">Másik szakit választottam</button>
            </div>
        `;

        // CHAT
        card.querySelector(".btn-chat").onclick = function(){
            window.location.href =
                `chat.html?sender=${encodeURIComponent(megrendelonev)}&partner=${encodeURIComponent(sz.name)}&orderId=${orderId}`;
        };

        // VÁLASZTÁS → NYERT SZAKI
        card.querySelector(".btn-choose").onclick = async function(){
            await window.MatchFlow_chooseWorker(orderId, sz.name);
            alert("Kiválasztottad: " + sz.name);
        };

        // ELUTASÍTÁS → VESZTETT SZAKI
        card.querySelector(".btn-reject").onclick = async function(){
            await window.MatchFlow_rejectWorker(orderId, sz.name);
            alert("Elutasítva: " + sz.name);
        };

        lista.appendChild(card);
    });

</script>

</body>
</html>

// Szaki-App – egységes szaki adatbázis + segédfüggvények
// Másold be ezt a fájlt változtatás nélkül a projekt gyökerébe.
// Minden oldal (regisztráció, szaki választás, chat) innen fog olvasni.

(function () {

    // --- TELEFON MASZK FUNKCIÓ ---
    // 5 lépcsős oldás: minden MEGOSZTÁS után 1 db csillag eltűnik
    function maskPhone(phone, shareCount = 0) {
        if (!phone) return "";
        const numbersOnly = phone.replace(/\D/g, ""); // csak szám
        const maxVisible = Math.min(shareCount, 5);
        const visibleCount = 6 + maxVisible; 
        const visible = numbersOnly.substring(0, visibleCount);
        const stars = "*".repeat(5 - maxVisible);
        return visible + stars;
    }

    // --- EMAIL MASZK FUNKCIÓ ---
    function maskEmail(email, shareCount = 0) {
        if (!email || typeof email !== "string") return "";
        const [user, domain] = email.split("@");
        if (!user || !domain) return email;

        const maxVisible = Math.min(shareCount, 5);
        const visible = user.substring(0, maxVisible);
        const stars = "*".repeat(Math.max(0, user.length - maxVisible));

        return visible + stars + "@" + domain;
    }

    // --- ALAP SZAKI LISTA (bővíthető) ---
    const SZAKIK = [
        {
            name: "Csabi",
            profession: ["Festő", "Burkoló", "Teljes felújítás"],
            note: "",
            phoneOriginal: "06201234567",
            emailOriginal: "csabi.mester@gmail.com",
            shareCount: 0,
            isReal: true,
            isOnline: true,
            priority: 100,
            maxJobs: Infinity,
            calendarAvailability: "always"
        },
        {
            name: "Zsolti",
            profession: ["Villanyszerelő", "Gépész"],
            note: "Gyors javítások, kisebb munkák azonnal",
            phoneOriginal: "06307654321",
            emailOriginal: "zsolti.villany@gmail.com",
            shareCount: 0,
            isReal: true,
            isOnline: true,
            priority: 90,
            maxJobs: Infinity,
            calendarAvailability: "always"
        },
        {
            name: "Demo Péter",
            profession: "Villanyszerelő",
            note: "Szabadság miatt nem elérhető",
            phoneOriginal: "06701112222",
            emailOriginal: "demo.szakember@gmail.com",
            shareCount: 0,
            isReal: false,
            isOnline: false,
            priority: 10,
            maxJobs: 3,
            holidays: { 
                from: "2025-08-01", 
                to: "2025-08-20" 
            },
            calendarAvailability: "busy"
        },
        {
            name: "Anna",
            profession: ["Festő"],
            note: "Több lakást is felújítottam",
            phoneOriginal: "06209998888",
            emailOriginal: "anna.festo@gmail.com",
            shareCount: 0,
            isReal: true,
            isOnline: false,
            priority: 30,
            maxJobs: 3,
            calendarAvailability: "normal"
        }
    ];


    // --- EXPORTÁLT OBJEKTUM ---
    window.SzakiAdatok = {

        // TELJES lista – biztonságos másolat
        getAllSzakik: function () {
            return SZAKIK.map(s => JSON.parse(JSON.stringify(s)));
        },

        // szakma alapján szűrés
        findByProfession: function (szakma) {
            return SZAKIK.filter(szaki => {
                if (Array.isArray(szaki.profession)) {
                    return szaki.profession.includes(szakma);
                }
                return szaki.profession === szakma;
            }).map(s => JSON.parse(JSON.stringify(s)));
        },

        // online szakik (elsődleges)
        getOnlineSzakik: function (szakma) {
            return SZAKIK
                .filter(sz => {
                    if (!sz.isOnline) return false;
                    if (Array.isArray(sz.profession)) {
                        return sz.profession.includes(szakma);
                    }
                    return sz.profession === szakma;
                })
                .map(s => JSON.parse(JSON.stringify(s)));
        },

        // naptár alapú fallback szakik
        getCalendarBasedBackup: function (szakma) {
            return SZAKIK
                .filter(sz => {
                    if (sz.isOnline) return false;
                    if (Array.isArray(sz.profession)) {
                        return sz.profession.includes(szakma);
                    }
                    return sz.profession === szakma;
                })
                .sort((a, b) => (b.priority || 0) - (a.priority || 0))
                .map(s => JSON.parse(JSON.stringify(s)));
        },

        // TELEFONSZÁM (maszkolt!)
        getMaskedPhone: function (szaki) {
            if (!szaki || !szaki.phoneOriginal) return "";
            return maskPhone(szaki.phoneOriginal, szaki.shareCount || 0);
        },

        // EMAIL (maszkolt!)
        getMaskedEmail: function (szaki) {
            if (!szaki || !szaki.emailOriginal) return "";
            return maskEmail(szaki.emailOriginal, szaki.shareCount || 0);
        },

        // szabadság kiírása
        getHolidayLabel: function (szaki) {
            if (!szaki || !szaki.holidays) return "";
            const h = szaki.holidays;
            if (h.from && h.to) return `Nyaralás: ${h.from} – ${h.to}`;
            if (h.from) return `Nyaralás kezdete: ${h.from}`;
            if (h.to) return `Nyaralás vége: ${h.to}`;
            return "";
        }
    };

})();

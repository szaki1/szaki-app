<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <title>V√°lassz szakembert ‚Äì Szaki-App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body{
            margin:0; padding:0;
            background:#f5f5f5;
            font-family:Arial, sans-serif;
        }

        header{
            background:#ff8c00;
            color:white;
            text-align:center;
            padding:16px;
            font-size:20px;
            font-weight:bold;
        }

        .container{
            max-width:900px;
            margin:0 auto;
            padding:16px;
        }

        .info-box{
            background:white;
            padding:14px 16px;
            margin-bottom:16px;
            border-radius:10px;
            box-shadow:0 2px 8px rgba(0,0,0,0.08);
            font-size:14px;
        }

        .szaki-card{
            background:white;
            padding:14px 16px;
            margin-bottom:12px;
            border-radius:12px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1);
        }

        .szaki-top{
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .szaki-name{
            font-size:18px;
            font-weight:bold;
        }

        .status{
            font-size:13px;
            padding:4px 10px;
            border-radius:20px;
            color:white;
        }

        .online{ background:#28a745; }
        .offline{ background:#777; }

        .lastseen{
            font-size:12px;
            color:#666;
            margin-top:6px;
        }

        .szaki-profession{
            font-size:14px;
            margin-top:4px;
            color:#555;
        }

        .actions{
            display:flex;
            gap:10px;
            margin-top:14px;
        }

        .btn-chat, .btn-choose, .btn-reject{
            flex:1;
            padding:10px;
            border:none;
            border-radius:8px;
            font-weight:bold;
            font-size:14px;
            cursor:pointer;
            color:white;
        }

        .btn-chat{ background:#007bff; }
        .btn-choose{ background:#28a745; }
        .btn-reject{ background:#c00; }

        /* Rekl√°mhely */
        .ads-box{
            background:#fff7e6;
            padding:15px;
            border-radius:10px;
            text-align:center;
            margin:20px 0;
            font-size:14px;
            border:1px dashed #ff8c00;
            color:#333;
        }
    </style>
</head>

<body>

<header>V√°lassz szakembert</header>

<div class="container">

    <div id="info-box" class="info-box"></div>

    <!-- Rekl√°m hely -->
    <div class="ads-box">üî∂ Rekl√°m hely (Google Ads / saj√°t banner)</div>

    <div id="szaki-lista"></div>

</div>

<!-- STATIKUS SZAKI LISTA -->
<script src="szaki-adatok.js"></script>

<!-- ONLINE MOTOR -->
<script src="szaki-online-engine.js"></script>

<!-- MATCHING FLOW -->
<script src="matching-job-flow.js"></script>

<!-- FIREBASE -->
<script type="module">

import { db } from "./firebase-config.js";
import {
    collection,
    query,
    where,
    getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


// =============================
// PARAM√âTEREK BET√ñLT√âSE
// =============================
const params = new URLSearchParams(window.location.search);

const megrendelonev = params.get("megrendelonev") || localStorage.getItem("mr_nev") || "";
const szakma = params.get("szakma") || localStorage.getItem("mr_szakma") || "";
const orderId = params.get("orderId") || null;


// =============================
// FEJL√âC KIT√ñLT√âSE
// =============================
document.getElementById("info-box").innerHTML = `
    <b>Megrendel≈ë:</b> ${megrendelonev}<br>
    <b>Keresett szakma:</b> ${szakma}<br>
    <b>Munka azonos√≠t√≥:</b> ${orderId}
`;


// =============================
// SZAKIK BET√ñLT√âSE
// =============================
async function loadWorkers() {

    const list = document.getElementById("szaki-lista");
    list.innerHTML = "Bet√∂lt√©s...";

    let items = [];

    try {
        const q = query(
            collection(db, "szakik"),
            where("profession", "==", szakma)
        );
        const snap = await getDocs(q);
        snap.forEach(d => items.push(d.data()));

    } catch (e) {
        console.error(e);
    }

    // Firestore √ºres ‚Üí SZAKI-ADATOK fallback
    if (items.length === 0) {
        items = window.SzakiAdatok.findByProfession(szakma);
    }

    list.innerHTML = "";

    items.forEach(sz => renderCard(sz));
}


// =============================
// SZAKI CARD KIRAJZOL√ì
// =============================
function renderCard(sz) {

    const list = document.getElementById("szaki-lista");

    const card = document.createElement("div");
    card.className = "szaki-card";

    const onlineLabel = sz.isOnline
        ? `<span class="status online">üü¢ online</span>`
        : `<span class="status offline">‚ö´ offline</span>`;

    const lastSeen = !sz.isOnline && sz.lastSeenMinutes
        ? `<div class="lastseen">Utolj√°ra akt√≠v: ${sz.lastSeenMinutes} perce</div>`
        : "";

    card.innerHTML = `
        <div class="szaki-top">
            <div class="szaki-name">${sz.name}</div>
            ${onlineLabel}
        </div>

        <div class="szaki-profession">${sz.profession}</div>
        ${lastSeen}

        <div class="actions">
            <button class="btn-chat">Chat</button>
            <button class="btn-choose">Ezt v√°lasztom</button>
            <button class="btn-reject">M√°sik szaki kell</button>
        </div>
    `;

    // CHAT
    card.querySelector(".btn-chat").onclick = () => {
        window.location.href =
            `chat.html?sender=${encodeURIComponent(megrendelonev)}&partner=${encodeURIComponent(sz.name)}&orderId=${orderId}`;
    };

    // V√ÅLASZT√ÅS
    card.querySelector(".btn-choose").onclick = async () => {
        await window.MatchFlow_chooseWorker(orderId, sz.name);
        alert(`Kiv√°lasztottad: ${sz.name}`);
    };

    // ELUTAS√çT√ÅS
    card.querySelector(".btn-reject").onclick = async () => {
        await window.MatchFlow_rejectWorker(orderId, sz.name);
        alert(`Elutas√≠tva: ${sz.name}`);
    };

    list.appendChild(card);
}


// =============================
// IND√çT√ÅS
// =============================
loadWorkers();

</script>

</body>
</html>

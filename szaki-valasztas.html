<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szakember v√°laszt√°s ‚Äì SzakiChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            background:#f4f4f4;
            margin:0;
            font-family:Arial, sans-serif;
        }

        header {
            background:#007aff;
            color:white;
            padding:16px;
            text-align:center;
            font-size:20px;
            font-weight:bold;
        }

        .box {
            background:white;
            border-radius:12px;
            padding:18px;
            box-shadow:0 2px 10px rgba(0,0,0,0.08);
            margin:14px;
        }

        .szakiItem {
            background:white;
            padding:16px;
            border-radius:12px;
            margin:12px;
            box-shadow:0 2px 8px rgba(0,0,0,0.08);
        }

        .szakiHeader {
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .szakiName {
            font-size:18px;
            font-weight:bold;
        }

        .szakiInfo {
            color:#555;
            margin-top:4px;
        }

        .btnChat {
            margin-top:10px;
            width:100%;
            padding:12px;
            background:#007aff;
            color:white;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-size:16px;
        }

        .btnChat:hover {
            transform:scale(1.02);
        }

        #lockMsg {
            background:#ffe9e8;
            color:#a10000;
            padding:12px;
            font-weight:bold;
            text-align:center;
            border-radius:8px;
            display:none;
        }
    </style>
</head>

<body>

<header>Szakember v√°laszt√°s</header>

<div class="container">

    <div class="box" id="headerBox">
        Bet√∂lt√©s...
    </div>

    <div class="box" id="lockMsg">
        üîí A szakik el√©rhet≈ës√©ge z√°rolva! Minimum 5 megoszt√°s sz√ºks√©ges.
    </div>

    <div id="szakiLista">Bet√∂lt√©s...</div>

</div>

<!-- ‚ù§Ô∏è T√°mogat√°s gomb -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">

/* ============================================================
   FIREBASE IMPORT
============================================================ */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";



/* ============================================================
   URL PARAM√âTER: SZAKMA
============================================================ */
const params = new URLSearchParams(window.location.search);
const szakma = params.get("szakma") || localStorage.getItem("mr_szakma") || "";
if (!szakma) window.location.href = "szakma-valasztas.html";

document.getElementById("headerBox").innerHTML = `
    <b>Keresett szakma:</b> ${szakma}
`;



/* ============================================================
   FELHASZN√ÅL√ì + SHARECOUNT BET√ñLT√âSE
============================================================ */
let uid = null;
let shareCount = 0;

onAuthStateChanged(auth, async (user) => {
    if (!user) window.location.href = "login.html";

    uid = user.uid;

    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
        shareCount = userSnap.data().shareCount || 0;
    }

    if (shareCount < 5) {
        document.getElementById("lockMsg").style.display = "block";
    }

    loadSzakik();
});



/* ============================================================
   SZAKIK LIST√ÅZ√ÅSA FIRESTORE-B√ìL
============================================================ */
async function loadSzakik() {
    const listDiv = document.getElementById("szakiLista");
    listDiv.innerHTML = "Bet√∂lt√©s...";

    const q = query(
        collection(db, "users"),
        where("role", "==", "szaki"),
        where("szakma", "==", szakma.toLowerCase())
    );

    const snap = await getDocs(q);

    if (snap.empty) {
        listDiv.innerHTML =
            "<p style='text-align:center; margin-top:20px;'>Nincs szakember ebben a kateg√≥ri√°ban.</p>";
        return;
    }

    listDiv.innerHTML = "";

    snap.forEach(docu => {
        const szaki = docu.data();
        const id = docu.id;

        const onlineIcon = szaki.online ? "üü¢" : "‚ö™";

        const phoneText = (shareCount >= 5)
            ? (szaki.phone || "Nincs megadva")
            : "üîí Z√°rolva (min. 5 megoszt√°s)";

        const div = document.createElement("div");
        div.className = "szakiItem";

        div.innerHTML = `
            <div class="szakiHeader">
                <div class="szakiName">${szaki.name || "Nincs n√©v"}</div>
                <div>${onlineIcon}</div>
            </div>

            <div class="szakiInfo"><b>Szakma:</b> ${szaki.szakma}</div>
            <div class="szakiInfo"><b>Telefon:</b> ${phoneText}</div>

            <button class="btnChat" onclick="startChat('${id}')">
                Chat ind√≠t√°sa
            </button>
        `;

        listDiv.appendChild(div);
    });
}



/* ============================================================
   CHAT L√âTREHOZ√ÅSA / MEGNYIT√ÅSA
============================================================ */
window.startChat = async function(partnerID) {

    // Chat ID gener√°l√°sa
    const chatID = uid < partnerID
        ? uid + "_" + partnerID
        : partnerID + "_" + uid;

    const chatRef = doc(db, "chats", chatID);
    const chatSnap = await getDoc(chatRef);

    if (!chatSnap.exists()) {
        await setDoc(chatRef, {
            participants: [uid, partnerID],
            lastMessage: "",
            lastTimestamp: Date.now()
        });
    }

    window.location.href =
        `chat.html?chatID=${chatID}&partner=${partnerID}`;
};

</script>

</body>
</html>

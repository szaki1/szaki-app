<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megrendel≈ë Profil</title>
    <link rel="stylesheet" href="style.css">
    <style>
      .fixed-buttons {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 1000;
      }
            .profession-container {
                display: block;
                margin-top: 16px;
                max-height: 260px;
                overflow-y: auto;
                border: 1px solid #ccc;
                border-radius: 10px;
                padding: 10px;
                background: #f9f9f9;
            }
      .profession-btn {
        display: block;
        margin: 6px 0;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
        text-align: left;
      }
    </style>
</head>
<body>
    <header style="padding:16px">
        <h1 style="margin:0">√údv√∂zl√ºnk a Megrendel≈ë Profilodon!</h1>
    </header>

    <!-- Nagy, kiemelt bej√∂v≈ë-√ºzenetek sz√°ml√°l√≥ (2. sor) -->
    <div id="bigInboxRow" style="display:flex;flex-direction:column;align-items:center;padding:12px 16px">
        <button id="headerInboxBtn" style="font-size:2.5rem;line-height:1;padding:18px 28px;border-radius:14px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.08);">
            üì• Bej√∂v≈ë √ºzenetek (0)
        </button>
        <!-- Besz√©lget√©seim gomb √©s lista JS-b≈ël gener√°lva -->
        <div id="convosContainer"></div>
    </div>
    <script type="module">
    // ...existing code...
    // --- Besz√©lget√©seim gomb √©s lista (csak JS-b≈ël, csak bejelentkezve!) ---
    const convosContainer = document.getElementById('convosContainer');
    let convosOpen = false;
    let convosList = null;
    let convosToggleBtn = null;
    function setupConvosUI(user) {
        convosContainer.innerHTML = '';
        convosToggleBtn = document.createElement('button');
        convosToggleBtn.id = 'convosToggleBtn';
        convosToggleBtn.textContent = 'üí¨ Besz√©lget√©seim';
        convosToggleBtn.style.cssText = 'margin-top:18px;font-size:1.2rem;padding:10px 22px;border-radius:10px;border:1px solid #2196f3;background:#e3f2fd;color:#1976d2;cursor:pointer;font-weight:bold;box-shadow:0 2px 8px rgba(33,150,243,0.08);';
        convosList = document.createElement('div');
        convosList.id = 'convosList';
        convosList.style.cssText = 'display:none;max-height:260px;overflow-y:auto;width:100%;background:#fff;border-radius:10px;margin-top:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:8px 0 8px 0;';
        convosContainer.appendChild(convosToggleBtn);
        convosContainer.appendChild(convosList);
        convosToggleBtn.addEventListener('click', async () => {
            convosOpen = !convosOpen;
            convosList.style.display = convosOpen ? 'block' : 'none';
            if (convosOpen) {
                convosList.innerHTML = '<div style="text-align:center;color:#888;padding:12px">Bet√∂lt√©s...</div>';
                if (!user) return;
                const chatsCol = collection(db, 'chats');
                const chatQ = query(chatsCol, where('megrId', '==', user.uid));
                const chatSnap = await getDocs(chatQ);
                if (chatSnap.empty) {
                    convosList.innerHTML = '<div style="text-align:center;color:#888;padding:12px">M√©g nincs besz√©lget√©sed.</div>';
                    return;
                }
                convosList.innerHTML = '';
                chatSnap.forEach(docSnap => {
                    const d = docSnap.data();
                    if (!d.szakiId) return;
                    const szakiName = d.szakiName || d.szakiId;
                    const szakma = d.szakma || '';
                    const lastMsg = d.lastMsg ? ` ‚Äì ${d.lastMsg.slice(0,40)}` : '';
                    const row = document.createElement('div');
                    row.style.cssText = 'padding:10px 18px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid #f0f0f0;font-size:1.05rem;';
                    row.innerHTML = `<span style=\"font-weight:bold;color:#1976d2\">${szakiName}</span> <span style=\"color:#888;font-size:0.98em\">${szakma}</span> <span style=\"color:#aaa;font-size:0.93em\">${lastMsg}</span>`;
                    row.onclick = () => location.href = `chat.html?szakiId=${d.szakiId}`;
                    convosList.appendChild(row);
                });
            }
        });
    }
    // ...existing code...
    </script>


    <main>
        <section>
            <p id="userInfo">Bet√∂lt√©s...</p>
            <p id="userEmail">Email: Bet√∂lt√©s...</p>
            <p id="userPhone">Telefonsz√°m: Bet√∂lt√©s...</p>
            <p id="userCity">V√°ros (munkav√©gz√©s helye): Bet√∂lt√©s...</p>
        </section>

        <!-- Szakma v√°laszt√≥ gombok -->
        <div style="text-align:center;margin-top:24px">
          <button id="toggleProfessions" style="font-size:1.8rem;line-height:1;padding:14px 20px;border-radius:10px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
            üõ†Ô∏è SZAKMA V√ÅLASZT√ÅS
          </button>
        </div>

                <div id="professionContainer" class="profession-container">
                    <!-- G√∂rgethet≈ë szakma lista -->
                    <button class="profession-btn" data-profession="Fest≈ë">üé® Fest≈ë</button>
                    <button class="profession-btn" data-profession="Burkol√≥">üî® Burkol√≥</button>
                    <button class="profession-btn" data-profession="Villanyszerel≈ë">‚ö° Villanyszerel≈ë</button>
                    <button class="profession-btn" data-profession="V√≠zszerel≈ë">üîß V√≠zszerel≈ë</button>
                    <button class="profession-btn" data-profession="G√°zszerel≈ë">üî• G√°zszerel≈ë</button>
                    <button class="profession-btn" data-profession="Gyors√©tkeztet√©si elad√≥">üçî Gyors√©tkeztet√©si elad√≥</button>
                    <button class="profession-btn" data-profession="Ford diagnosztika">üöó Ford diagnosztika</button>
                    <button class="profession-btn" data-profession="K≈ëm≈±ves">üß± K≈ëm≈±ves</button>
                    <button class="profession-btn" data-profession="√Åcs">ü™ö √Åcs</button>
                    <button class="profession-btn" data-profession="Tet≈ëfed≈ë">üè† Tet≈ëfed≈ë</button>
                    <button class="profession-btn" data-profession="Gipszkartonos">üü´ Gipszkartonos</button>
                    <button class="profession-btn" data-profession="F≈±t√©sszerel≈ë">üî• F≈±t√©sszerel≈ë</button>
                    <button class="profession-btn" data-profession="Parkett√°s">ü™µ Parkett√°s</button>
                    <button class="profession-btn" data-profession="B√°dogos">üî© B√°dogos</button>
                    <button class="profession-btn" data-profession="M√°zol√≥">üñåÔ∏è M√°zol√≥</button>
                    <button class="profession-btn" data-profession="Kert√©sz">üå≥ Kert√©sz</button>
                    <button class="profession-btn" data-profession="T√©rk√∂vez≈ë">üß± T√©rk√∂vez≈ë</button>
                </div>

        <!-- Keres√©s mez≈ë -->
        <div style="margin:18px 0 0 0;max-width:500px;margin-left:auto;margin-right:auto;">
            <input type="text" id="searchInput" placeholder="üîç Keres√©s n√©v, v√°ros vagy ker√ºlet szerint..." style="width:100%;padding:12px;font-size:16px;border-radius:10px;border:1px solid #ccc;box-sizing:border-box" />
        </div>

        <!-- Szaki lista -->
        <div id="list" style="margin-top:18px;"></div>

    </main>

    <!-- Hang √©s PWA gombok -->
    <div class="fixed-buttons">
      <button id="soundToggle" style="background:#4caf50;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px">
        üîä Hang
      </button>
      <button id="honestyBox" onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')" style="background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff;padding:12px 18px;border-radius:28px;font-weight:bold;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.25);">
        üí∞ Becs√ºlet kassza
      </button>
      <button id="donateBtn" onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')" style="background:#ff2d55;color:#fff;padding:12px 18px;border-radius:30px;font-weight:bold;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25);">
        ‚ù§Ô∏è Adom√°ny
      </button>
    </div>

    <script src="draggable-buttons.js"></script>

    <script type="module" src="firebase-config.js"></script>
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // --- Szakik list√°z√°sa, keres√©s, szakma sz≈±r√©s ---
        let allSzakikData = [];
        let selectedProfession = null;

        function formatName(fullName) {
            if (!fullName) return "N√©vtelen";
            const parts = fullName.trim().split(" ");
            if (parts.length === 1) return parts[0];
            const firstName = parts[0];
            const restName = parts.slice(1).join(" ");
            return `${firstName.charAt(0)}. ${restName}`;
        }

        function renderFilteredSzakik() {
            const list = document.getElementById('list');
            if (!list) return;
            let szakik = allSzakikData;
            const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            if (selectedProfession) {
                szakik = szakik.filter(sz => sz.szakma === selectedProfession);
            }
            if (search) {
                szakik = szakik.filter(sz =>
                    (sz.name && sz.name.toLowerCase().includes(search)) ||
                    (sz.varos && sz.varos.toLowerCase().includes(search)) ||
                    (sz.kerulet && sz.kerulet.toLowerCase().includes(search))
                );
            }
            list.innerHTML = '';
            if (szakik.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#888;padding:18px">Nincs tal√°lat.</div>';
                return;
            }
            szakik.forEach(szaki => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                  <div style="display:flex;justify-content:space-between;align-items:start">
                    <div class="name">${formatName(szaki.name)}</div>
                  </div>
                  <div class="status">${szaki.status || ''}</div>
                  ${szaki.ratingStars || ''}
                  ${szaki.recsText || ''}
                  ${szaki.priceText || ''}
                  ${szaki.infoText ? `<div class="desc" style="font-size:13px;color:#666;margin-top:4px">${szaki.infoText}</div>` : ''}
                  ${szaki.desc ? `<div class="desc" style="margin-top:6px">${szaki.desc}</div>` : ''}
                `;
                div.onclick = () => {
                    location.href = `chat.html?szakiId=${szaki.id}`;
                };
                list.appendChild(div);
            });
        }

        async function loadSzakik(profession = null) {
            selectedProfession = profession;
            let szakikCol = collection(db, 'users');
            let szakikQ = query(szakikCol, where('role', '==', 'szaki'), where('isFake', '!=', true));
            if (profession) {
                szakikQ = query(szakikCol, where('role', '==', 'szaki'), where('isFake', '!=', true), where('szakma', '==', profession));
            }
            const snap = await getDocs(szakikQ);
            allSzakikData = [];
            snap.forEach(doc => {
                const d = doc.data();
                allSzakikData.push({
                    id: doc.id,
                    name: d.name,
                    szakma: d.szakma,
                    varos: d.varos,
                    kerulet: d.kerulet,
                    status: d.online ? '<span class="on">Online</span>' : '<span class="off">Offline</span>',
                    ratingStars: d.rating ? '‚≠ê'.repeat(Math.round(d.rating)) : '',
                    recsText: d.recommendations ? `<span style="color:#2196f3;font-weight:bold">Aj√°nl√°sok: ${d.recommendations}</span>` : '',
                    priceText: d.price ? `<span style="color:#888">${d.price} Ft/√≥ra</span>` : '',
                    infoText: d.info,
                    desc: d.desc
                });
            });
            renderFilteredSzakik();
        }

        // --- Esem√©nykezel≈ëk ---
        window.addEventListener("DOMContentLoaded", () => {
            // Szakma gombok
            document.querySelectorAll('.profession-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const profession = btn.dataset.profession;
                    loadSzakik(profession);
                });
            });
            // Keres√©s input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    renderFilteredSzakik();
                });
            }
            // Hang gomb
            const soundToggleBtn = document.getElementById('soundToggle');
            if (soundToggleBtn) {
                soundToggleBtn.addEventListener('click', () => {
                    const currentState = localStorage.getItem('notificationSound') !== 'false';
                    const newState = !currentState;
                    localStorage.setItem('notificationSound', newState);
                    soundToggleBtn.textContent = newState ? 'üîä Hang' : 'üîá Hang';
                    soundToggleBtn.style.background = newState ? '#4caf50' : '#9e9e9e';
                    alert(newState ? 'üîä Csipog√≥ hang BEKAPCSOLVA' : 'üîá Csipog√≥ hang KIKAPCSOLVA (csak rezg√©s)');
                });
            }
            // Alap√©rtelmezett szaki lista bet√∂lt√©s
            loadSzakik();
        });

        // --- Profil √©s chat logika (megl√©v≈ë k√≥d) ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                location.replace('index.html');
                return;
            }

            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists() || userDoc.data().role !== 'megrendelo') {
                location.replace('index.html');
                return;
            }

            const userData = userDoc.data();
            document.getElementById('userInfo').textContent = `N√©v: ${userData.name}`;
            document.getElementById('userEmail').textContent = `Email: ${userData.email || user.email || 'nincs megadva'}`;
            document.getElementById('userPhone').textContent = `Telefonsz√°m: ${userData.telefon || userData.phone || 'nincs megadva'}`;
            document.getElementById('userCity').textContent = `V√°ros (munkav√©gz√©s helye): ${userData.varos || userData.city || 'nincs megadva'}`;

            // √Åthelyezz√ºk a kil√©p√©s gombot a profil inf√≥ al√°
            const logoutSmall = document.createElement('div');
            logoutSmall.style.marginTop = '8px';
            logoutSmall.innerHTML = '<button id="logoutSmallBtn" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer">Kil√©p√©s</button>';
            document.querySelector('main section:nth-of-type(1)').appendChild(logoutSmall);
            document.getElementById('logoutSmallBtn').addEventListener('click', logout);

            // Jelsz√≥ megjelen√≠t√©se NEM ENGED√âLYEZETT biztons√°gi okokb√≥l.
            // Helyette k√≠n√°ljuk a jelsz√≥-vissza√°ll√≠t√≥ link k√ºld√©s√©t az emailre.
            document.getElementById('sendResetBtn').addEventListener('click', async () => {
                const status = document.getElementById('resetStatus');
                status.textContent = 'K√ºld√©s folyamatban‚Ä¶';
                try {
                    const targetEmail = userData.email || user.email;
                    if (!targetEmail) throw new Error('Nincs el√©rhet≈ë email c√≠m a fi√≥khoz.');
                    await sendPasswordResetEmail(auth, targetEmail);
                    status.textContent = 'A jelsz√≥-vissza√°ll√≠t√≥ link elk√ºldve az email c√≠mre.';
                } catch (err) {
                    console.error('Jelsz√≥ vissza√°ll√≠t√≥ k√ºld√©s hiba:', err);
                    status.textContent = 'Hiba: nem siker√ºlt elk√ºldeni. Ellen≈ërizd az email c√≠met.';
                }
            });
            // Bej√∂v≈ë √ºzenetek sz√°ml√°l√≥: √∂sszes unreadCountMegr √∂sszead√°sa a chats gy≈±jtem√©nyb≈ël
            try {
                const chatsCol = collection(db, 'chats');
                const chatQ = query(chatsCol, where('megrId', '==', user.uid));
                const chatSnap = await getDocs(chatQ);
                let unreadTotal = 0;
                chatSnap.forEach(c => {
                    const cd = c.data();
                    const u = cd.unreadCountMegr || 0;
                    unreadTotal += u;
                });

                // Friss√≠ts√ºk a fejl√©c Bej√∂v≈ë √ºzenetek gomb felirat√°t
                const headerBtn = document.getElementById('headerInboxBtn');
                if (headerBtn) {
                    headerBtn.textContent = `üì• Bej√∂v≈ë √ºzenetek (${unreadTotal})`;
                    headerBtn.onclick = () => location.href = 'megrendelo-inbox.html';
                }
            } catch (err) {
                console.error('Bej√∂v≈ë √ºzenetek sz√°ml√°l√≥ lek√©r√©se sikertelen:', err);
            }

            // ...nincs t√∂bb teszt-gomb vagy aj√°nl√°s statisztika...
            // Besz√©lget√©seim gomb csak bejelentkezve
            setupConvosUI(user);
        });

        function logout() {
            auth.signOut().then(() => {
                location.replace('index.html');
            });
        }
    </script>
    <script>
      document.getElementById('toggleProfessions').addEventListener('click', () => {
        const container = document.getElementById('professionContainer');
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
      });

      // Szakm√°k rendez√©se ABC szerint (p√©lda, ha dinamikusan t√∂ltj√ºk be Firestore-b√≥l)
      const professions = [
        { name: "Fest≈ë", icon: "üé®" },
        { name: "Burkol√≥", icon: "üî®" },
        { name: "Villanyszerel≈ë", icon: "‚ö°" },
        { name: "V√≠zszerel≈ë", icon: "üîß" },
        { name: "G√°zszerel≈ë", icon: "üî•" },
        { name: "Gyors√©tkeztet√©si elad√≥", icon: "üçî" },
        { name: "Ford diagnosztika", icon: "üöó" }
      ];

      professions.sort((a, b) => a.name.localeCompare(b.name, "hu"));

      const professionContainer = document.getElementById("professionContainer");
      professionContainer.innerHTML = "";
      professions.forEach(prof => {
        const btn = document.createElement("button");
        btn.className = "profession-btn";
        btn.textContent = `${prof.icon} ${prof.name}`;
        btn.dataset.profession = prof.name;
        professionContainer.appendChild(btn);
      });
    </script>
</body>
</html>
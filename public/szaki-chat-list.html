<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>SzakiChat ‚Äì Besz√©lget√©sek</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body { font-family: Arial; background:#f2f2f2; margin:0; }
    header {
        background:#ff8c00; color:white;
        padding:18px; text-align:center;
        font-size:22px; font-weight:bold;
    }

    .listBox {
        max-width:500px; margin:20px auto;
        background:white; padding:20px;
        border-radius:12px;
        box-shadow:0 4px 14px rgba(0,0,0,0.1);
    }

    .chatItem {
        padding:14px; margin-bottom:14px;
        border-radius:10px; background:#fafafa;
        border:1px solid #ddd; cursor:pointer;
        transition:0.15s;
    }

    .chatItem:hover { background:#f0f0f0; }

    .name { font-size:18px; font-weight:bold; }
    .info { font-size:14px; color:#666; margin-top:2px; }

    .adBox {
        background:#fff7d6;
        padding:12px; text-align:center;
        border-radius:10px; margin-bottom:20px;
        border:1px solid #e6cf88;
        font-size:15px;
    }

    #supportFloatingBtn {
        position: fixed;
        bottom: 22px;
        right: 22px;
        background: #ff2d55;
        padding: 14px 22px;
        border-radius: 40px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        display: flex; gap: 10px;
        align-items: center;
        box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    }
    .heart { animation: heartbeat 1.4s infinite; }
    @keyframes heartbeat {
        0%{transform:scale(1);}
        25%{transform:scale(1.25);}
        40%{transform:scale(1);}
        60%{transform:scale(1.25);}
        100%{transform:scale(1);}
    }
</style>
</head>

<body>

<header>Besz√©lget√©seim</header>

<div class="listBox">

    <div class="adBox">üî∂ Hirdet√©si hely (Google Ads)</div>

    <h3>Akt√≠v besz√©lget√©sek</h3>
    <div id="activeList">Bet√∂lt√©s‚Ä¶</div>

    <hr style="margin:25px 0;">

    <h3>√öj megkeres√©sek</h3>
    <div id="newList">Bet√∂lt√©s‚Ä¶</div>

</div>

<!-- ‚ù§Ô∏è Adom√°ny -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
     <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>

<!-- üî• JAV√çTOTT SZAKI CHAT LIST SCRIPT ‚Äì EGYBEN -->
<script type="module">

// FIREBASE import ‚Äî helyes!
import { db, auth } from "./firebase-config.js";

import {
    doc, getDoc,
    collection, query, where,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";


let uid = null;
let szakiData = null;
let blocked = [];


// ===============================
// BEL√âP√âS ELLEN≈êRZ√âSE
// ===============================
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    uid = user.uid;

    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);

    szakiData = snap.data();
    blocked = szakiData.blockedUsers || [];

    watchChats();
});


// ===============================
// CHATEK LIST√ÅZ√ÅSA REALTIME
// ===============================
function watchChats() {
    const q = query(
        collection(db, "chats"),
        where("szakiID", "==", uid)
    );

    onSnapshot(q, (snap) => {
        const activeDiv = document.getElementById("activeList");
        const newDiv = document.getElementById("newList");

        activeDiv.innerHTML = "";
        newDiv.innerHTML = "";

        snap.forEach(docu => {
            const c = docu.data();

            // Blokkolt √ºgyf√©l nem jelenik meg
            if (blocked.includes(c.userID)) return;

            const isActive = c.accepted === true;

            const item = `
                <div class="chatItem" onclick="openChat('${c.userID}')">
                    <div class="name">${c.userName || c.name || "Ismeretlen"}</div>
                    <div class="info">${c.lastMessage || "‚Äî nincs √ºzenet ‚Äî"}</div>
                </div>
            `;

            if (isActive) activeDiv.innerHTML += item;
            else newDiv.innerHTML += item;
        });

        if (!activeDiv.innerHTML.trim())
            activeDiv.innerHTML = "<i>Nincs akt√≠v besz√©lget√©s.</i>";

        if (!newDiv.innerHTML.trim())
            newDiv.innerHTML = "<i>Nincs √∫j megkeres√©s.</i>";
    });
}


// ===============================
// CHAT MEGNYIT√ÅSA
// ===============================
window.openChat = function(partnerID) {
    window.location.href = `szaki-chat.html?partner=${partnerID}`;
};

</script>

</body>
</html>

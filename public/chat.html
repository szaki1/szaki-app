<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>SzakiChat ‚Äì Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body { font-family:Arial; margin:0; background:#f2f2f2; }

    header {
        background:#007aff; color:white;
        padding:14px; font-size:20px; font-weight:bold;
        display:flex; justify-content:space-between; align-items:center;
    }

    #onlineDot {
        font-size:20px;
    }

    #chatBox {
        max-width:480px; margin:0 auto;
        height:70vh; overflow-y:auto;
        background:white; padding:14px;
        border-radius:12px; margin-top:10px;
        box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    .msg {
        padding:10px 14px; margin:8px 0;
        border-radius:10px; max-width:75%;
        line-height:1.4; word-wrap:break-word;
    }
    .me { background:#d1e7ff; margin-left:auto; }
    .other { background:#ececec; margin-right:auto; }

    .inputArea {
        max-width:480px; margin:10px auto;
        display:flex; gap:6px;
    }

    input[type=text] {
        flex:1; padding:10px;
        border-radius:8px; border:1px solid #ccc;
    }

    button {
        padding:10px 12px; border:none;
        border-radius:8px; cursor:pointer;
        font-size:16px; background:#007aff; color:white;
    }

    .mic { background:#4caf50; }
    .imgBtn { background:#ff9800; }

    .imgThumb {
        max-width:180px;
        border-radius:8px;
        margin-top:6px;
    }

    /* ‚ù§Ô∏è Adom√°ny gomb */
    #supportFloatingBtn {
        position: fixed; bottom:22px; right:22px;
        background:#ff2d55; padding:14px 22px;
        border-radius:40px; color:white;
        font-weight:bold; cursor:pointer;
        display:flex; gap:10px; align-items:center;
        box-shadow:0 4px 14px rgba(0,0,0,0.25);
    }
    .heart { animation: heartbeat 1.4s infinite; }
    @keyframes heartbeat {
        0%{transform:scale(1);}
        25%{transform:scale(1.25);}
        40%{transform:scale(1);}
        60%{transform:scale(1.25);}
        100%{transform:scale(1);}
    }
</style>
</head>

<body>

<header>
    <span id="partnerName">Chat</span>
    <span id="onlineDot">‚ö™</span>
</header>

<div id="chatBox">Bet√∂lt√©s‚Ä¶</div>

<div class="inputArea">
    <input id="msgInput" type="text" placeholder="√çrj √ºzenetet‚Ä¶">
    <button onclick="sendMessage()">‚û§</button>
    <button class="mic" onclick="startDictation()">üé§</button>
</div>

<div class="inputArea">
    <input type="file" id="imgUpload">
    <button class="imgBtn" onclick="sendImage()">üì∏</button>
</div>

<!-- ‚ù§Ô∏è Adom√°ny -->
<div id="supportFloatingBtn"
     onclick="window.open('https://www.paypal.com/donate/?hosted_button_id=QGU3WXVSCH22A','_blank')">
    <span class="heart">‚ù§Ô∏è</span> T√°mogasd a SzakiChat-et
</div>


<script type="module">

/* ===================================================
   FIREBASE IMPORT ‚Äì JAV√çTVA!!!
=================================================== */
import { auth, db } from "./firebase-config.js";

import {
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
    doc, getDoc, updateDoc,
    onSnapshot, arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ===================================================
   PARAM√âTEREK
=================================================== */
const params = new URLSearchParams(window.location.search);
const chatID = params.get("chatID");
const partnerID = params.get("partner");

const chatRef = doc(db, "chats", chatID);
const partnerRef = doc(db, "users", partnerID);

let myUID = null;
let myName = "";
let partnerName = "";
let partnerOnline = false;


/* ===================================================
   BEL√âP√âS ELLEN≈êRZ√âSE
=================================================== */
onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    myUID = user.uid;

    const mySnap = await getDoc(doc(db, "users", myUID));
    myName = mySnap.data().name;

    const partnerSnap = await getDoc(partnerRef);
    partnerName = partnerSnap.data().name;
    document.getElementById("partnerName").innerText = partnerName;

    loadChat();
    watchPartnerOnline();
});


/* ===================================================
   PARTNER ONLINE FIGYEL√âSE
=================================================== */
function watchPartnerOnline() {
    onSnapshot(partnerRef, (snap) => {
        const d = snap.data();
        partnerOnline = d.online;

        document.getElementById("onlineDot").innerText =
            partnerOnline ? "üü¢" : "‚ö™";
    });
}


/* ===================================================
   CHAT BET√ñLT√âSE
=================================================== */
function loadChat() {
    const box = document.getElementById("chatBox");

    onSnapshot(chatRef, (snap) => {
        if (!snap.exists()) return;

        const msgs = snap.data().messages || [];

        box.innerHTML = "";

        msgs.forEach(m => {
            if (m.type === "img") {
                box.innerHTML += `
                    <div class="msg ${m.from === myUID ? "me" : "other"}">
                        <img src="${m.url}" class="imgThumb">
                    </div>
                `;
            } else {
                box.innerHTML += `
                    <div class="msg ${m.from === myUID ? "me" : "other"}">
                        ${m.text}
                    </div>
                `;
            }
        });

        box.scrollTop = box.scrollHeight;
    });
}


/* ===================================================
   √úZENET K√úLD√âSE
=================================================== */
window.sendMessage = async function() {
    const inp = document.getElementById("msgInput");
    const text = inp.value.trim();
    if (!text) return;

    await updateDoc(chatRef, {
        messages: arrayUnion({
            from: myUID,
            text,
            type: "text",
            time: Date.now()
        }),
        lastMessage: text
    });

    inp.value = "";
};


/* ===================================================
   K√âP K√úLD√âSE
=================================================== */
window.sendImage = async function() {
    const file = document.getElementById("imgUpload").files[0];
    if (!file) return alert("Nincs kiv√°lasztva k√©p!");

    const fakeUrl = URL.createObjectURL(file);

    await updateDoc(chatRef, {
        messages: arrayUnion({
            from: myUID,
            url: fakeUrl,
            type: "img",
            time: Date.now()
        }),
        lastMessage: "üì∏ K√©p csatolva"
    });
};


/* ===================================================
   DIKT√ÅL√ÅS
=================================================== */
window.startDictation = function() {
    if (!("webkitSpeechRecognition" in window)) {
        alert("A b√∂ng√©sz≈ë nem t√°mogatja a dikt√°l√°st.");
        return;
    }

    const rec = new webkitSpeechRecognition();
    rec.lang = "hu-HU";
    rec.continuous = false;
    rec.onresult = e => {
        document.getElementById("msgInput").value =
            e.results[0][0].transcript;
    };
    rec.start();
};

</script>

</body>
</html>
